# Story 2.7: Store Generated Images

**Epic:** Epic 2 - Image Generation Engine
**Story ID:** 2.7
**Title:** Store Generated Images
**Priority:** Must Have
**Complexity:** Medium
**Status:** Draft

---

## User Story

As the system, I need to store generated images securely so that users can download them and reference them later.

---

## Acceptance Criteria

- [ ] Generated images stored in cloud storage (local filesystem for MVP)
- [ ] Images organized by generation session ID
- [ ] Secure, expiring URLs generated for download (7 days)
- [ ] Images retained for minimum 7 days
- [ ] Storage cleanup job for expired images (placeholder for MVP)
- [ ] Image metadata stored in database (type, generation date, etc.)

---

## Technical Notes

### Storage Structure
```
storage/
|-- generated/
    |-- {session_id}/
        |-- main.png
        |-- infographic_1.png
        |-- infographic_2.png
        |-- lifestyle.png
        |-- comparison.png
```

### Image Record Model
```python
class ImageRecord(Base):
    __tablename__ = "image_records"

    id = Column(Integer, primary_key=True)
    session_id = Column(String(36), ForeignKey("generation_sessions.id"))
    image_type = Column(Enum(ImageTypeEnum))  # main, infographic_1, etc.
    storage_path = Column(String(500))
    status = Column(Enum(GenerationStatusEnum))
    created_at = Column(DateTime)
    completed_at = Column(DateTime)
```

### URL Generation
For MVP (local storage):
```python
def get_image_url(session_id: str, image_type: str) -> str:
    return f"/storage/generated/{session_id}/{image_type}.png"
```

For Phase 2 (S3):
```python
def get_image_url(session_id: str, image_type: str) -> str:
    return s3.generate_presigned_url(
        'get_object',
        Params={'Bucket': bucket, 'Key': f"{session_id}/{image_type}.png"},
        ExpiresIn=7 * 24 * 60 * 60  # 7 days
    )
```

### Image Saving
```python
def save_generated_image(session_id: str, image_type: str, image: PILImage) -> str:
    path = f"storage/generated/{session_id}/{image_type}.png"
    image.save(path, format='PNG', optimize=True)
    return path
```

---

## Dependencies

- **Depends On:** Story 5.4, Stories 2.2-2.5
- **Required By:** Story 3.1, Story 3.3, Story 3.4

---

## Definition of Done

- [ ] Images saved to correct directory structure
- [ ] Session ID used for organization
- [ ] Database records created for each image
- [ ] Image URLs accessible from frontend
- [ ] Metadata stored (type, status, timestamps)
- [ ] Files are actual PNG images, not corrupted
- [ ] Cleanup job placeholder exists (not fully implemented in MVP)
