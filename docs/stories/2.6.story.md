# Story 2.6: Handle Generation Errors with Retry Logic

**Epic:** Epic 2 - Image Generation Engine
**Story ID:** 2.6
**Title:** Handle Generation Errors with Retry Logic
**Priority:** Must Have
**Complexity:** Medium
**Status:** Draft

---

## User Story

As a user, I want the system to automatically retry if image generation fails so that I receive my images without manual intervention.

---

## Acceptance Criteria

- [ ] System implements retry logic with max 3 attempts per image
- [ ] Exponential backoff between retries (1s, 2s, 4s)
- [ ] Different prompts attempted on retry (prompt variation)
- [ ] User notified of retry attempts in progress UI
- [ ] Partial success handled (some images generated)
- [ ] Complete failure triggers appropriate error message
- [ ] All failures logged with details for debugging

---

## Technical Notes

### Retry Configuration
```python
class RetryConfig:
    MAX_RETRIES = 3
    BASE_DELAY = 1  # seconds
    MAX_DELAY = 8   # seconds
```

### Exponential Backoff
```
Attempt 1: Immediate
Attempt 2: Wait 1 second
Attempt 3: Wait 2 seconds
Attempt 4: Wait 4 seconds (if max > 3)
```

### Prompt Variation on Retry
```python
variations = [
    "\n[VARIATION: Emphasize clarity and simplicity]",
    "\n[VARIATION: Focus on product detail and precision]",
    "\n[VARIATION: Prioritize clean composition]",
]
```

### Status Updates
Each image has status:
- `pending` - Not started
- `processing` - Currently generating
- `complete` - Successfully generated
- `failed` - Failed after all retries

### Session Status Logic
- All 5 complete -> `complete`
- 1-4 complete -> `partial`
- 0 complete -> `failed`

### Logging Requirements
On failure, log:
- Session ID
- Image type
- Error message
- Retry count
- Prompt used (or hash)

---

## Dependencies

- **Depends On:** Stories 2.2, 2.3, 2.4, 2.5
- **Required By:** Story 2.7, Story 3.1

---

## Definition of Done

- [ ] Retry logic implemented with 3 max attempts
- [ ] Exponential backoff works correctly
- [ ] Prompt variations applied on retry
- [ ] Status updates visible in frontend
- [ ] Partial success handled gracefully
- [ ] Complete failure shows appropriate message
- [ ] All errors logged with context
- [ ] Database updated with retry count and error messages
