# Story 2.1: Connect to Gemini API

**Epic:** Epic 2 - Image Generation Engine
**Story ID:** 2.1
**Title:** Connect to Gemini API
**Priority:** Must Have
**Complexity:** Medium
**Status:** Draft

---

## User Story

As the system, I need to connect to the Gemini API so that I can generate images using AI.

---

## Acceptance Criteria

- [ ] System authenticates with Gemini API using google-genai SDK
- [ ] API credentials stored securely as environment variables
- [ ] Connection test endpoint available for health checks
- [ ] Proper error handling for authentication failures
- [ ] API timeout handling (60 second limit per request)
- [ ] Rate limit detection and handling
- [ ] Reference image support (pass uploaded product photo to API)

---

## Technical Notes

### Gemini Service Reference
See `docs/architecture.md` Section 5.1 for GeminiService implementation.

### API Configuration
```python
from google import genai
from google.genai import types

client = genai.Client(api_key=settings.gemini_api_key)
model = "gemini-3-pro-image-preview"
```

### Reference Image Usage
```python
# Pass product photo as reference to maintain accuracy
contents = [prompt, uploaded_product_image]

response = client.models.generate_content(
    model="gemini-3-pro-image-preview",
    contents=contents,
    config=types.GenerateContentConfig(
        response_modalities=['Image'],
        image_config=types.ImageConfig(aspect_ratio="1:1")
    )
)
```

### Environment Variable
```
GEMINI_API_KEY=your-api-key-here
```

### Error Handling
- Authentication failure: Clear error message
- Rate limit: Queue request with backoff
- Timeout: Retry with exponential backoff
- Invalid response: Log and retry

---

## Dependencies

- **Depends On:** Story 5.1, Story 5.3
- **Required By:** Story 2.1b, Story 2.2, Story 2.3, Story 2.4, Story 2.5

---

## Definition of Done

- [ ] GeminiService class implemented
- [ ] API key loaded from environment
- [ ] Health check verifies API connection
- [ ] Reference image can be passed to API
- [ ] Timeout handling works (60s)
- [ ] Rate limit detection implemented
- [ ] Error responses logged properly
- [ ] Generated images can be extracted from response
