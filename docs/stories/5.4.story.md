# Story 5.4: Configure Cloud Storage

**Epic:** Epic 5 - Core Infrastructure
**Story ID:** 5.4
**Title:** Configure Cloud Storage
**Priority:** Must Have
**Complexity:** Medium
**Status:** Draft

---

## User Story

As the system, I need cloud storage configured so that generated images can be stored and retrieved.

---

## Acceptance Criteria

- [ ] Storage provider configured (local filesystem for MVP, S3-ready)
- [ ] Upload functionality implemented
- [ ] Signed URL generation for secure access
- [ ] URL expiration set (7 days default)
- [ ] Storage bucket/container properly secured
- [ ] Cleanup job for expired images (placeholder for MVP)

---

## Technical Notes

### Storage Service Reference
See `docs/architecture.md` Section 9.3 and 10.3 for storage architecture.

### Storage Structure
```
storage/
|-- uploads/         # Uploaded product images
|   |-- {uuid}.png
|-- generated/       # Generated listing images
|   |-- {session_id}/
|       |-- main.png
|       |-- infographic_1.png
|       |-- infographic_2.png
|       |-- lifestyle.png
|       |-- comparison.png
```

### StorageService Interface
```python
class StorageService:
    def save_upload(content: bytes, original_filename: str) -> str
    def save_generated_image(session_id: str, image_type: str, image: PILImage) -> str
    def get_upload_path(upload_id: str) -> Path
    def get_image_url(session_id: str, image_type: str) -> str
```

### Security Considerations
- Generate random UUID filenames (prevent path traversal)
- Re-encode images to strip EXIF metadata
- Validate file types using magic numbers
- Store in isolated directories

---

## Dependencies

- **Depends On:** Story 5.1 (FastAPI Backend Setup)
- **Required By:** Story 1.1 (Upload), Story 2.7 (Image Storage)

---

## Definition of Done

- [ ] Upload directory created and accessible
- [ ] Generated images directory created
- [ ] Files can be saved with UUID filenames
- [ ] Files can be retrieved by ID
- [ ] File URLs are accessible from frontend
- [ ] Security: Path traversal prevented
- [ ] Security: EXIF data stripped from uploads
