# Story 2.4: Infographic Image Generation

**Epic:** Phase 2 - AI Core
**Priority:** Must Have
**Complexity:** Large
**Status:** Ready for Implementation

---

## User Story

As a user, I want infographic images that highlight my product's key features so that customers quickly understand my product's benefits.

---

## Acceptance Criteria

- [ ] System generates 2 infographic images
- [ ] Infographic 1 highlights key feature #1 with bold text
- [ ] Infographic 2 highlights key feature #2 with bold text
- [ ] Text is large and readable at thumbnail size
- [ ] Product is visible alongside feature callouts
- [ ] Text density is under 20% of image area
- [ ] Output resolution is 2000x2000px minimum
- [ ] Images saved to cloud storage with unique identifiers
- [ ] Test: Generate both infographics from test product

---

## Implementation Details

### Full Implementation

```python
# app/services/generation_service.py (continued)

async def generate_infographic_images(
    session_id: str,
    db: Session,
    gemini: GeminiService,
    prompts: PromptEngine,
    storage: StorageService
) -> tuple[bool, bool]:
    """
    Generate both infographic images.

    Returns:
        Tuple of (infographic_1_success, infographic_2_success)
    """
    session = db.query(GenerationSession).filter_by(id=session_id).first()
    if not session:
        return (False, False)

    # Build product context
    keywords = {kw.keyword: kw.intent_types for kw in session.keywords}
    context = ProductContext(
        title=session.product_title,
        features=[session.feature_1, session.feature_2, session.feature_3],
        target_audience=session.target_audience,
        keywords=list(keywords.keys()),
        intents=keywords
    )

    results = []

    # Generate both infographics
    for image_number in [1, 2]:
        image_type = ImageTypeEnum.INFOGRAPHIC_1 if image_number == 1 else ImageTypeEnum.INFOGRAPHIC_2
        template_key = f'infographic_{image_number}'

        # Find or create image record
        image_record = db.query(ImageRecord).filter_by(
            session_id=session_id,
            image_type=image_type
        ).first()

        if not image_record:
            image_record = ImageRecord(
                session_id=session_id,
                image_type=image_type
            )
            db.add(image_record)
            db.commit()

        try:
            # Update status to processing
            image_record.status = GenerationStatusEnum.PROCESSING
            db.commit()

            # Build prompt
            prompt = prompts.build_prompt(template_key, context)

            # Generate image
            generated_image = await gemini.generate_image(
                prompt=prompt,
                reference_image_path=session.upload_path,
                aspect_ratio="1:1"
            )

            if generated_image:
                # Save to storage
                path = storage.save_generated_image(
                    session_id=session_id,
                    image_type=template_key,
                    image=generated_image
                )

                # Update record
                image_record.storage_path = path
                image_record.status = GenerationStatusEnum.COMPLETE
                image_record.completed_at = datetime.utcnow()
                db.commit()
                results.append(True)
            else:
                image_record.status = GenerationStatusEnum.FAILED
                image_record.error_message = "No image returned from API"
                db.commit()
                results.append(False)

        except Exception as e:
            image_record.status = GenerationStatusEnum.FAILED
            image_record.error_message = str(e)
            image_record.retry_count += 1
            db.commit()
            results.append(False)

    return (results[0], results[1]) if len(results) == 2 else (False, False)
```

---

## Creative Blueprint Requirements

From `docs/creative-blueprint.md` Section 2:

### Micro-Copywriting Rules

| Rule | Description |
|------|-------------|
| **Text as Design** | Use text overlays as a design element, not just a caption |
| **Bold & High-Contrast** | Fonts must be legible at thumbnail size |
| **Benefits Over Features** | "Sleep Better" not "10mg Melatonin" |
| **One Message Per Image** | Each infographic has ONE singular objective |

### Example Prompt Outputs

Infographic 1 might emphasize:
- **Problem/Solution Intent**: "Finally, Sleep Through the Night"
- **Durability Intent**: "30-Day Supply of Better Sleep"

Infographic 2 might emphasize:
- **Use Case Intent**: "Perfect for Busy Professionals"
- **Problem/Solution Intent**: "Wake Up Refreshed"

---

## Testing Instructions

### 1. Create Test

Create `tests/test_infographic_generation.py`:

```python
"""
Test Infographic Image Generation
"""
import pytest
import asyncio
from pathlib import Path
from app.services.gemini_service import GeminiService
from app.prompts.engine import PromptEngine, ProductContext
from app.services.storage_service import StorageService

@pytest.mark.asyncio
async def test_generate_both_infographics():
    """Test generating both infographic images"""
    gemini = GeminiService()
    prompts = PromptEngine()
    storage = StorageService(storage_path="./tests/output")

    context = ProductContext(
        title="Organic Sleep Gummies",
        features=[
            "All-natural melatonin formula",
            "Non-habit forming",
            "Delicious berry flavor"
        ],
        target_audience="Busy professionals",
        keywords=["sleep aid", "natural", "melatonin"],
        intents={
            "sleep aid": ["problem_solution"],
            "natural": ["durability"],
            "melatonin": ["use_case"]
        }
    )

    test_image_path = Path(__file__).parent / "fixtures" / "test-product.jpg"
    if not test_image_path.exists():
        pytest.skip("Test product image not found")

    # Generate both infographics
    for infographic_num in [1, 2]:
        print(f"\nðŸ“Š Generating Infographic {infographic_num}...")

        prompt = prompts.build_prompt(f'infographic_{infographic_num}', context)
        print(f"Prompt emphasizes Feature {infographic_num}")

        generated_image = await gemini.generate_image(
            prompt=prompt,
            reference_image_path=str(test_image_path),
            aspect_ratio="1:1"
        )

        assert generated_image is not None, f"Failed to generate infographic {infographic_num}"

        # Verify dimensions
        width, height = generated_image.size
        assert width >= 2000 and height >= 2000

        # Save image
        output_path = storage.save_generated_image(
            session_id="test_session",
            image_type=f"infographic_{infographic_num}",
            image=generated_image
        )

        print(f"âœ… Infographic {infographic_num} saved: {output_path}")


@pytest.mark.asyncio
async def test_infographic_prompts_are_different():
    """Verify that the two infographic prompts emphasize different features"""
    prompts = PromptEngine()
    context = ProductContext(
        title="Test Product",
        features=["Feature A", "Feature B", "Feature C"],
        target_audience="Test audience",
        keywords=["test"],
        intents={}
    )

    prompt1 = prompts.build_prompt('infographic_1', context)
    prompt2 = prompts.build_prompt('infographic_2', context)

    # Verify they highlight different features
    assert "Feature A" in prompt1
    assert "Feature B" in prompt2
    assert prompt1 != prompt2


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
```

### 2. Run Tests

```bash
pytest tests/test_infographic_generation.py -v -s
```

---

## Reference Documentation

- **Creative Blueprint**: Section 2 - "Secondary Imagery: The Mobile Storyboard"
- **Architecture**: Section 5.3 - Infographic Prompt Templates
- **PRD**: Story 2.3 - Infographic Image Generation

---

## Dependencies

- **Upstream**: Stories 2.1, 2.2
- **Downstream**: Story 2.7

---

## Definition of Done

- [x] Both infographic generation functions implemented
- [x] Prompts use templates from Story 2.2
- [x] Text overlays are design elements (not just captions)
- [x] Benefit-focused messaging ("Sleep Better" not "10mg")
- [x] Images meet resolution requirements
- [x] Images saved to storage
- [x] Tests generate both infographics
- [x] Error handling implemented

---

## Notes

- Infographics communicate benefits QUICKLY to mobile shoppers
- Text must be legible at thumbnail size
- Each infographic has ONE primary message
- Avoid feature lists - focus on outcomes
