# Implementation Story 5.2: Image Preview Modal

**Epic:** Output & Delivery (Phase 5)
**Story:** Image Preview/Zoom Modal
**Priority:** Should Have
**Complexity:** Small
**Estimated Time:** 3-4 hours

---

## User Story

As a user, I want to click on an image to view it full-size so that I can check quality and details.

---

## Acceptance Criteria

- [ ] Clicking image opens full-size preview modal
- [ ] Modal displays image at maximum screen-fitting size
- [ ] Close button (X) clearly visible
- [ ] ESC key closes modal
- [ ] Click outside modal (backdrop) closes it
- [ ] Navigate between images with arrow keys
- [ ] Previous/Next buttons visible
- [ ] Image label displays below image
- [ ] Download button in modal

---

## Implementation

### Modal Component

**File:** `frontend/src/pages/GalleryStep/ImagePreviewModal.tsx`

```tsx
import React, { useEffect } from 'react';
import { X, ChevronLeft, ChevronRight, Download } from 'lucide-react';
import { useAppContext } from '../../contexts/AppContext';
import { ImageType } from '../../types';

interface ImagePreviewModalProps {
  imageUrl: string;
  onClose: () => void;
}

const IMAGE_TYPES: ImageType[] = ['main', 'infographic_1', 'infographic_2', 'lifestyle', 'comparison'];

const IMAGE_LABELS: Record<ImageType, string> = {
  main: 'Main Product Image',
  infographic_1: 'Infographic 1',
  infographic_2: 'Infographic 2',
  lifestyle: 'Lifestyle Image',
  comparison: 'Comparison Chart',
};

export default function ImagePreviewModal({ imageUrl, onClose }: ImagePreviewModalProps) {
  const { generatedImages } = useAppContext();
  const [currentIndex, setCurrentIndex] = React.useState(0);

  // Find current image index
  useEffect(() => {
    const index = IMAGE_TYPES.findIndex(type =>
      generatedImages[type]?.url === imageUrl
    );
    if (index !== -1) setCurrentIndex(index);
  }, [imageUrl, generatedImages]);

  // Keyboard navigation
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (e.key === 'Escape') onClose();
      if (e.key === 'ArrowLeft') handlePrevious();
      if (e.key === 'ArrowRight') handleNext();
    };

    document.addEventListener('keydown', handleKeyDown);
    return () => document.removeEventListener('keydown', handleKeyDown);
  }, [currentIndex]);

  // Prevent body scroll when modal open
  useEffect(() => {
    document.body.style.overflow = 'hidden';
    return () => {
      document.body.style.overflow = 'unset';
    };
  }, []);

  const handlePrevious = () => {
    setCurrentIndex(prev => (prev > 0 ? prev - 1 : IMAGE_TYPES.length - 1));
  };

  const handleNext = () => {
    setCurrentIndex(prev => (prev < IMAGE_TYPES.length - 1 ? prev + 1 : 0));
  };

  const handleBackdropClick = (e: React.MouseEvent) => {
    if (e.target === e.currentTarget) onClose();
  };

  const currentImageType = IMAGE_TYPES[currentIndex];
  const currentImage = generatedImages[currentImageType];

  if (!currentImage) return null;

  return (
    <div className="modal-overlay" onClick={handleBackdropClick}>
      <div className="modal-container">
        {/* Close Button */}
        <button className="modal-close" onClick={onClose} aria-label="Close modal">
          <X size={24} />
        </button>

        {/* Navigation Buttons */}
        <button className="modal-nav modal-nav-prev" onClick={handlePrevious} aria-label="Previous image">
          <ChevronLeft size={32} />
        </button>

        <button className="modal-nav modal-nav-next" onClick={handleNext} aria-label="Next image">
          <ChevronRight size={32} />
        </button>

        {/* Image Content */}
        <div className="modal-content">
          <img
            src={currentImage.url}
            alt={IMAGE_LABELS[currentImageType]}
            className="modal-image"
          />

          {/* Image Info */}
          <div className="modal-info">
            <p className="modal-label">{IMAGE_LABELS[currentImageType]}</p>
            <p className="modal-counter">{currentIndex + 1} / {IMAGE_TYPES.length}</p>
          </div>

          {/* Download Button */}
          <button className="modal-download">
            <Download size={16} />
            Download This Image
          </button>
        </div>
      </div>
    </div>
  );
}
```

### Styling

**File:** `frontend/src/pages/GalleryStep/ImagePreviewModal.module.css`

```css
/* Modal Overlay */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.85);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.2s ease-out;
}

/* Modal Container */
.modal-container {
  position: relative;
  max-width: 90vw;
  max-height: 90vh;
  animation: scaleUp 0.2s ease-out;
}

/* Close Button */
.modal-close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: white;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
  z-index: 10;
}

.modal-close:hover {
  background: rgba(255, 255, 255, 0.2);
}

/* Navigation Buttons */
.modal-nav {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(255, 255, 255, 0.1);
  border: none;
  color: white;
  width: 48px;
  height: 48px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.2s;
  z-index: 10;
}

.modal-nav:hover {
  background: rgba(255, 255, 255, 0.2);
}

.modal-nav-prev {
  left: 1rem;
}

.modal-nav-next {
  right: 1rem;
}

/* Modal Content */
.modal-content {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1rem;
}

.modal-image {
  max-width: 85vw;
  max-height: 75vh;
  object-fit: contain;
  border-radius: 8px;
}

/* Modal Info */
.modal-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  width: 100%;
  padding: 0 1rem;
}

.modal-label {
  color: white;
  font-size: 1.125rem;
  font-weight: 600;
}

.modal-counter {
  color: rgba(255, 255, 255, 0.7);
  font-size: 0.875rem;
}

/* Download Button */
.modal-download {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  background: #10B981;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s;
}

.modal-download:hover {
  background: #059669;
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes scaleUp {
  from {
    opacity: 0;
    transform: scale(0.9);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

/* Mobile Adjustments */
@media (max-width: 767px) {
  .modal-image {
    max-width: 95vw;
    max-height: 70vh;
  }

  .modal-nav {
    width: 40px;
    height: 40px;
  }

  .modal-close {
    width: 40px;
    height: 40px;
  }
}

/* Touch Swipe Support (Mobile) */
@media (pointer: coarse) {
  .modal-nav {
    display: none; /* Hide arrows on touch devices */
  }
}
```

---

## Testing

```tsx
describe('ImagePreviewModal', () => {
  it('should close on ESC key', () => {
    const onClose = jest.fn();
    render(<ImagePreviewModal imageUrl="/test.png" onClose={onClose} />);

    fireEvent.keyDown(document, { key: 'Escape' });
    expect(onClose).toHaveBeenCalled();
  });

  it('should navigate with arrow keys', () => {
    render(<ImagePreviewModal imageUrl="/test.png" onClose={() => {}} />);

    fireEvent.keyDown(document, { key: 'ArrowRight' });
    // Assert next image displayed
  });

  it('should close on backdrop click', () => {
    const onClose = jest.fn();
    const { container } = render(<ImagePreviewModal imageUrl="/test.png" onClose={onClose} />);

    fireEvent.click(container.querySelector('.modal-overlay'));
    expect(onClose).toHaveBeenCalled();
  });
});
```

---

## API Integration

Reuses download endpoint from Story 5.3:
- `GET /api/download/{session_id}/{image_type}`

---

## Definition of Done

- [ ] Modal opens on image click
- [ ] Full-size image displays correctly
- [ ] All close methods work (X, ESC, backdrop click)
- [ ] Keyboard navigation works (arrows)
- [ ] Prev/Next buttons functional
- [ ] Download button works
- [ ] Responsive on mobile/desktop
- [ ] No body scroll when modal open
- [ ] Tests passing
- [ ] Accessibility tested
