# Story 2.5: Lifestyle Image Generation

**Epic:** Phase 2 - AI Core
**Priority:** Must Have
**Complexity:** Large
**Status:** Ready for Implementation

---

## User Story

As a user, I want a lifestyle image with an Instagram-style aesthetic so that customers can envision using my product.

---

## Acceptance Criteria

- [ ] System generates lifestyle image using specialized prompt
- [ ] Image has authentic, Instagram-style photography feel
- [ ] Product shown in realistic usage context
- [ ] Context matches target audience description
- [ ] Professional lighting and composition
- [ ] Output resolution is 2000x2000px minimum
- [ ] Image saved to cloud storage with unique identifier
- [ ] Test: Generate lifestyle image from test product

---

## Implementation Details

### Full Implementation

```python
# app/services/generation_service.py (continued)

async def generate_lifestyle_image(
    session_id: str,
    db: Session,
    gemini: GeminiService,
    prompts: PromptEngine,
    storage: StorageService
) -> bool:
    """
    Generate lifestyle image showing product in use.

    Returns:
        True if successful, False otherwise
    """
    session = db.query(GenerationSession).filter_by(id=session_id).first()
    if not session:
        return False

    # Build product context
    keywords = {kw.keyword: kw.intent_types for kw in session.keywords}
    context = ProductContext(
        title=session.product_title,
        features=[session.feature_1, session.feature_2, session.feature_3],
        target_audience=session.target_audience,
        keywords=list(keywords.keys()),
        intents=keywords
    )

    # Find or create image record
    image_record = db.query(ImageRecord).filter_by(
        session_id=session_id,
        image_type=ImageTypeEnum.LIFESTYLE
    ).first()

    if not image_record:
        image_record = ImageRecord(
            session_id=session_id,
            image_type=ImageTypeEnum.LIFESTYLE
        )
        db.add(image_record)
        db.commit()

    try:
        # Update status to processing
        image_record.status = GenerationStatusEnum.PROCESSING
        db.commit()

        # Build prompt - lifestyle emphasizes USE CASE and STYLE intents
        prompt = prompts.build_prompt('lifestyle', context)

        # Generate image
        generated_image = await gemini.generate_image(
            prompt=prompt,
            reference_image_path=session.upload_path,
            aspect_ratio="1:1"
        )

        if generated_image:
            # Save to storage
            path = storage.save_generated_image(
                session_id=session_id,
                image_type='lifestyle',
                image=generated_image
            )

            # Update record
            image_record.storage_path = path
            image_record.status = GenerationStatusEnum.COMPLETE
            image_record.completed_at = datetime.utcnow()
            db.commit()
            return True
        else:
            image_record.status = GenerationStatusEnum.FAILED
            image_record.error_message = "No image returned from API"
            db.commit()
            return False

    except Exception as e:
        image_record.status = GenerationStatusEnum.FAILED
        image_record.error_message = str(e)
        image_record.retry_count += 1
        db.commit()
        return False
```

---

## Creative Blueprint Requirements

From `docs/creative-blueprint.md` Section 2 - "The Instagramify Effect":

### What to AVOID

| Avoid | Do Instead |
|-------|------------|
| Clinical, sterile looks | High-end social media content feel |
| Stock photo aesthetics | Authentic, warm, relatable imagery |
| Empty backgrounds | Real people in real settings |
| Perfect, fake scenarios | Someone actually using product (sunlit kitchen, etc.) |

### Model Selection Rules

| Rule | Implementation |
|------|----------------|
| **Look Like Target** | Person in photos should look like target customer |
| **Aspirational Option** | Or who they aspire to be |
| **Expression = Result** | Expression mirrors result of using product |
| **Emotion Examples** | Relief, joy, focus, confidence, relaxation |

### Example Use Cases by Product

- **Sleep Gummies**: Person in pajamas, sunlit bedroom, peaceful morning routine
- **Fitness Supplements**: Athletic person post-workout, gym or outdoor setting
- **Baby Products**: Parent with baby, nursery or living room, natural lighting
- **Tech Gadgets**: Person using device at desk, modern office or home setup
- **Kitchen Products**: Cooking scene, inviting kitchen, food preparation

---

## Testing Instructions

### 1. Create Test

Create `tests/test_lifestyle_generation.py`:

```python
"""
Test Lifestyle Image Generation
"""
import pytest
import asyncio
from pathlib import Path
from app.services.gemini_service import GeminiService
from app.prompts.engine import PromptEngine, ProductContext
from app.services.storage_service import StorageService

@pytest.mark.asyncio
async def test_generate_lifestyle_image():
    """Test lifestyle image generation with Instagram aesthetic"""
    gemini = GeminiService()
    prompts = PromptEngine()
    storage = StorageService(storage_path="./tests/output")

    # Sleep gummies example
    context = ProductContext(
        title="Organic Sleep Gummies",
        features=[
            "All-natural melatonin formula",
            "Non-habit forming",
            "Delicious berry flavor"
        ],
        target_audience="Busy professionals aged 25-45 seeking better sleep",
        keywords=["sleep gummies", "natural sleep aid", "better sleep"],
        intents={
            "sleep gummies": ["problem_solution", "use_case"],
            "natural sleep aid": ["durability"],
            "better sleep": ["problem_solution"]
        }
    )

    test_image_path = Path(__file__).parent / "fixtures" / "test-product.jpg"
    if not test_image_path.exists():
        pytest.skip("Test product image not found")

    # Build prompt
    prompt = prompts.build_prompt('lifestyle', context)
    print(f"\nðŸ“¸ Lifestyle Prompt:\n{prompt}\n")

    # Verify prompt contains lifestyle elements
    assert "lifestyle" in prompt.lower() or "instagram" in prompt.lower()
    assert "authentic" in prompt.lower() or "real" in prompt.lower()

    # Generate image
    generated_image = await gemini.generate_image(
        prompt=prompt,
        reference_image_path=str(test_image_path),
        aspect_ratio="1:1"
    )

    assert generated_image is not None, "Failed to generate lifestyle image"

    # Verify dimensions
    width, height = generated_image.size
    assert width >= 2000 and height >= 2000

    # Save image
    output_path = storage.save_generated_image(
        session_id="test_session",
        image_type="lifestyle",
        image=generated_image
    )

    print(f"âœ… Lifestyle image saved: {output_path}")


@pytest.mark.asyncio
async def test_lifestyle_uses_target_audience():
    """Verify lifestyle prompt incorporates target audience"""
    prompts = PromptEngine()

    context = ProductContext(
        title="Test Product",
        features=["F1", "F2", "F3"],
        target_audience="Young parents with toddlers",
        keywords=["test"],
        intents={}
    )

    prompt = prompts.build_prompt('lifestyle', context)

    # Should reference target audience in use case
    assert "Young parents" in prompt or "toddlers" in prompt or "parent" in prompt.lower()


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
```

### 2. Run Tests

```bash
pytest tests/test_lifestyle_generation.py -v -s
```

---

## Reference Documentation

- **Creative Blueprint**: Section 2 - "The Instagramify Effect"
- **Architecture**: Section 5.4 - Lifestyle Prompt Template
- **PRD**: Story 2.4 - Lifestyle Image Generation

---

## Dependencies

- **Upstream**: Stories 2.1, 2.2
- **Downstream**: Story 2.7

---

## Definition of Done

- [x] Lifestyle generation function implemented
- [x] Prompt uses template from Story 2.2
- [x] Image has Instagram-style aesthetic
- [x] Product shown in authentic usage context
- [x] Context matches target audience
- [x] Image meets resolution requirements
- [x] Image saved to storage
- [x] Test generates lifestyle image
- [x] Error handling implemented

---

## Notes

- Lifestyle image builds DESIRE through aspiration
- Should feel like high-end social media content, not stock photos
- Model/person should match target demographic
- Expression shows positive outcome of using product
- This is about EMOTION, not just showing the product
