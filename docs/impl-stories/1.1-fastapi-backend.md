# Story 1.1: FastAPI Backend Setup

**Phase:** 1 - Foundation
**Story ID:** 1.1
**Title:** Set Up FastAPI Backend
**Priority:** Must Have
**Complexity:** Medium
**Status:** Ready for Development

---

## User Story

As a developer, I need a FastAPI backend set up so that the frontend can interact with APIs for all features.

---

## Acceptance Criteria

- [ ] FastAPI application with proper project structure
- [ ] Environment variable configuration (.env support)
- [ ] CORS configured for frontend origin (localhost:5173)
- [ ] Health check endpoint (GET /health)
- [ ] Error handling middleware
- [ ] Request logging middleware
- [ ] API documentation via Swagger UI (/docs)

---

## Project Structure (IMPLEMENT THIS)

```
listing_genie/
├── app/
│   ├── __init__.py
│   ├── main.py                 # FastAPI app entry point
│   ├── config.py               # Settings from environment
│   ├── dependencies.py         # Dependency injection
│   │
│   ├── api/
│   │   ├── __init__.py
│   │   ├── router.py           # Main API router
│   │   └── endpoints/
│   │       ├── __init__.py
│   │       └── health.py       # Health check endpoint
│   │
│   ├── core/
│   │   ├── __init__.py
│   │   ├── exceptions.py       # Custom exceptions
│   │   ├── logging_config.py   # Logging setup
│   │   └── middleware.py       # Request logging, error handling
│   │
│   ├── models/                 # SQLAlchemy models (Story 1.2)
│   ├── schemas/                # Pydantic schemas
│   ├── services/               # Business logic (Story 2.x)
│   └── prompts/                # Prompt templates (Story 2.2)
│
├── tests/
│   └── test_health.py
│
├── requirements.txt
├── .env.example
├── .gitignore
└── README.md
```

---

## Code to Implement

### app/main.py

```python
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware
from app.api.router import api_router
from app.core.middleware import LoggingMiddleware, ErrorHandlerMiddleware
from app.config import settings

app = FastAPI(
    title="Listing Genie API",
    description="AI-powered Amazon listing image generator",
    version="1.0.0"
)

# CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=settings.CORS_ORIGINS,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# Custom middleware
app.add_middleware(LoggingMiddleware)
app.add_middleware(ErrorHandlerMiddleware)

# Routes
app.include_router(api_router)

@app.get("/health")
async def health_check():
    return {"status": "healthy", "service": "listing-genie"}
```

### app/config.py

```python
from pydantic_settings import BaseSettings
from typing import List

class Settings(BaseSettings):
    # API
    API_PREFIX: str = "/api"
    DEBUG: bool = False

    # CORS
    CORS_ORIGINS: List[str] = ["http://localhost:5173", "http://localhost:3000"]

    # Gemini (for later)
    GEMINI_API_KEY: str = ""

    # Storage
    STORAGE_PATH: str = "./storage"

    # Database
    DATABASE_URL: str = "sqlite:///./listing_genie.db"

    class Config:
        env_file = ".env"
        case_sensitive = True

settings = Settings()
```

### app/api/router.py

```python
from fastapi import APIRouter
from app.api.endpoints import health

api_router = APIRouter(prefix="/api")
api_router.include_router(health.router, tags=["health"])
```

### app/api/endpoints/health.py

```python
from fastapi import APIRouter

router = APIRouter()

@router.get("/health")
async def api_health():
    return {
        "status": "healthy",
        "service": "listing-genie",
        "version": "1.0.0",
        "dependencies": {
            "database": "not_checked",  # Will implement in Story 1.2
            "storage": "not_checked",   # Will implement in Story 1.3
            "gemini": "not_checked"     # Will implement in Story 2.1
        }
    }
```

### app/core/middleware.py

```python
import time
import logging
from fastapi import Request, Response
from starlette.middleware.base import BaseHTTPMiddleware

logger = logging.getLogger(__name__)

class LoggingMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        start_time = time.time()
        response = await call_next(request)
        process_time = time.time() - start_time

        logger.info(
            f"{request.method} {request.url.path} "
            f"- {response.status_code} - {process_time:.3f}s"
        )
        return response

class ErrorHandlerMiddleware(BaseHTTPMiddleware):
    async def dispatch(self, request: Request, call_next):
        try:
            return await call_next(request)
        except Exception as e:
            logger.exception(f"Unhandled error: {e}")
            return Response(
                content='{"error": "Internal server error"}',
                status_code=500,
                media_type="application/json"
            )
```

### app/core/exceptions.py

```python
from fastapi import HTTPException

class ListingGenieException(HTTPException):
    def __init__(self, status_code: int, detail: str):
        super().__init__(status_code=status_code, detail=detail)

class ValidationError(ListingGenieException):
    def __init__(self, detail: str):
        super().__init__(status_code=400, detail=detail)

class GenerationError(ListingGenieException):
    def __init__(self, detail: str):
        super().__init__(status_code=500, detail=detail)
```

### app/core/logging_config.py

```python
import logging
import sys

def setup_logging():
    logging.basicConfig(
        level=logging.INFO,
        format="%(asctime)s - %(name)s - %(levelname)s - %(message)s",
        handlers=[
            logging.StreamHandler(sys.stdout)
        ]
    )

setup_logging()
```

### requirements.txt

```
fastapi>=0.109.0
uvicorn[standard]>=0.27.0
pydantic>=2.5.0
pydantic-settings>=2.1.0
python-dotenv>=1.0.0
python-multipart>=0.0.6
```

### .env.example

```
DEBUG=true
GEMINI_API_KEY=your_key_here
CORS_ORIGINS=["http://localhost:5173"]
DATABASE_URL=sqlite:///./listing_genie.db
STORAGE_PATH=./storage
```

### .gitignore

```
# Python
__pycache__/
*.py[cod]
venv/
.env

# Storage
storage/
*.db

# IDE
.vscode/
.idea/

# Node (for frontend)
node_modules/
dist/
```

---

## Test Gate (Must Pass Before Story 1.2)

```bash
# Start the server
uvicorn app.main:app --reload

# Test health endpoints
curl http://localhost:8000/health
# Expected: {"status": "healthy", "service": "listing-genie"}

curl http://localhost:8000/api/health
# Expected: {"status": "healthy", "service": "listing-genie", "version": "1.0.0", ...}

# Test Swagger UI
# Open http://localhost:8000/docs in browser
# Expected: Interactive API documentation loads

# Test CORS (from browser console on localhost:5173)
fetch('http://localhost:8000/health').then(r => r.json()).then(console.log)
# Expected: No CORS error, returns health response
```

---

## Dependencies

- **Depends On:** None (first story)
- **Blocks:** 1.2, 1.3, 1.4, 2.1

---

## Definition of Done

- [ ] All files created per structure above
- [ ] `uvicorn app.main:app --reload` starts without errors
- [ ] GET /health returns 200
- [ ] GET /api/health returns 200
- [ ] Swagger UI loads at /docs
- [ ] Request logging visible in console
- [ ] Error handling returns JSON (not HTML stacktrace)
- [ ] CORS allows localhost:5173

---

## Notes for Developer

1. **Pattern Reference:** See `C:\Nebula Colors\software\gemini_mcp\` for similar Python project structure
2. **Don't Add Yet:** Database, storage, Gemini - those are separate stories
3. **Keep Simple:** This is foundation only, don't over-engineer
4. **Empty __init__.py files:** Create them for all packages
