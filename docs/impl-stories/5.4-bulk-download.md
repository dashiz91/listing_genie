# Implementation Story 5.4: Bulk Download (ZIP)

**Epic:** Output & Delivery (Phase 5)
**Story:** Download All Images as ZIP
**Priority:** Must Have
**Complexity:** Medium
**Estimated Time:** 4-5 hours

---

## User Story

As a user, I want to download all images at once as a ZIP file so that I can quickly get all my listing images.

---

## Acceptance Criteria

- [ ] "Download All" button prominently displayed
- [ ] ZIP file contains all 5 images
- [ ] Each image in ZIP has descriptive filename
- [ ] ZIP file named with product title or session ID
- [ ] Download progress indicator for ZIP creation
- [ ] ZIP generation happens server-side
- [ ] Download works on mobile devices
- [ ] Button disabled if any images still generating

---

## Backend Implementation

### ZIP Download Endpoint

**File:** `app/api/endpoints/download.py`

```python
from fastapi import APIRouter, HTTPException, Depends, BackgroundTasks
from fastapi.responses import StreamingResponse
from pathlib import Path
from sqlalchemy.orm import Session
from app.db.session import get_db
from app.models.database import GenerationSession, ImageRecord, GenerationStatusEnum
from app.services.storage_service import StorageService
from app.config import settings
import zipfile
import io

router = APIRouter()
storage = StorageService(settings.storage_path)

@router.get("/download/{session_id}/zip")
async def download_all_images_zip(
    session_id: str,
    db: Session = Depends(get_db)
):
    """
    Download all generated images as a ZIP file.

    Creates a ZIP file in-memory containing all 5 generated images
    with descriptive filenames.
    """
    # Get the generation session
    session = db.query(GenerationSession).filter_by(id=session_id).first()

    if not session:
        raise HTTPException(404, "Session not found")

    if session.status != GenerationStatusEnum.COMPLETE:
        raise HTTPException(400, "Generation not complete")

    # Get all image records
    images = db.query(ImageRecord).filter_by(
        session_id=session_id,
        status=GenerationStatusEnum.COMPLETE
    ).all()

    if len(images) < 5:
        raise HTTPException(400, f"Only {len(images)}/5 images complete")

    # Create ZIP file in memory
    zip_buffer = io.BytesIO()

    with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zip_file:
        for image in images:
            file_path = Path(image.storage_path)

            if not file_path.exists():
                continue

            # Create filename
            filename = f"listing_{image.image_type.value}.png"

            # Add file to ZIP
            zip_file.write(file_path, arcname=filename)

    # Reset buffer position
    zip_buffer.seek(0)

    # Generate ZIP filename from product title
    product_title_safe = "".join(
        c for c in session.product_title if c.isalnum() or c in (' ', '-', '_')
    ).rstrip()
    product_title_safe = product_title_safe.replace(' ', '_')[:50]  # Max 50 chars

    zip_filename = f"{product_title_safe}_listing_images.zip"

    # Return ZIP file
    return StreamingResponse(
        iter([zip_buffer.getvalue()]),
        media_type="application/zip",
        headers={
            "Content-Disposition": f'attachment; filename="{zip_filename}"'
        }
    )
```

---

## Frontend Implementation

### Download All Button Component

**File:** `frontend/src/pages/GalleryStep/DownloadAllButton.tsx`

```tsx
import React from 'react';
import { Download } from 'lucide-react';
import { useAppContext } from '../../contexts/AppContext';
import { apiClient } from '../../api/client';

interface DownloadAllButtonProps {
  disabled?: boolean;
}

export default function DownloadAllButton({ disabled = false }: DownloadAllButtonProps) {
  const { sessionId, productInfo } = useAppContext();
  const [isDownloading, setIsDownloading] = React.useState(false);

  const handleDownloadAll = async () => {
    if (!sessionId) {
      alert('Session not found');
      return;
    }

    setIsDownloading(true);

    try {
      const blob = await apiClient.downloadZip(sessionId);

      // Create download link
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;

      // Generate filename from product title
      const safeTitle = productInfo.title
        .replace(/[^a-zA-Z0-9-_ ]/g, '')
        .replace(/\s+/g, '_')
        .substring(0, 50);

      link.download = `${safeTitle}_listing_images.zip`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Bulk download failed:', error);
      alert('Download failed. Please try again or download images individually.');
    } finally {
      setIsDownloading(false);
    }
  };

  return (
    <button
      className="btn-download-all"
      onClick={handleDownloadAll}
      disabled={disabled || isDownloading}
    >
      {isDownloading ? (
        <>
          <span className="spinner" />
          Creating ZIP...
        </>
      ) : (
        <>
          <Download size={20} />
          Download All as ZIP
        </>
      )}
    </button>
  );
}
```

### API Client Method

**File:** `frontend/src/api/client.ts`

```typescript
class ApiClient {
  // ... existing code ...

  async downloadZip(sessionId: string): Promise<Blob> {
    const response = await this.client.get(
      `/download/${sessionId}/zip`,
      {
        responseType: 'blob',
        timeout: 120000, // 2 minute timeout for ZIP creation
      }
    );
    return response.data;
  }
}
```

### Styling

**File:** `frontend/src/pages/GalleryStep/DownloadAllButton.module.css`

```css
.btn-download-all {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  padding: 1rem 2rem;
  background: #10B981;
  color: white;
  border: none;
  border-radius: 8px;
  font-size: 1.125rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
  margin: 2rem auto;
  box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
}

.btn-download-all:hover:not(:disabled) {
  background: #059669;
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(16, 185, 129, 0.4);
}

.btn-download-all:disabled {
  background: #D1D5DB;
  cursor: not-allowed;
  box-shadow: none;
}

.spinner {
  width: 20px;
  height: 20px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Mobile */
@media (max-width: 767px) {
  .btn-download-all {
    width: 100%;
    max-width: 400px;
  }
}
```

---

## Testing

### Backend Tests

**File:** `tests/test_api/test_download.py`

```python
import zipfile
import io

def test_download_zip_success(client, test_session_complete):
    """Test successful ZIP download"""
    response = client.get(f"/api/download/{test_session_complete.id}/zip")

    assert response.status_code == 200
    assert response.headers["content-type"] == "application/zip"
    assert "attachment" in response.headers["content-disposition"]
    assert ".zip" in response.headers["content-disposition"]

    # Verify ZIP contents
    zip_data = io.BytesIO(response.content)
    with zipfile.ZipFile(zip_data, 'r') as zip_file:
        filenames = zip_file.namelist()
        assert len(filenames) == 5
        assert "listing_main.png" in filenames
        assert "listing_infographic_1.png" in filenames
        assert "listing_infographic_2.png" in filenames
        assert "listing_lifestyle.png" in filenames
        assert "listing_comparison.png" in filenames

def test_download_zip_not_complete(client, test_session_pending):
    """Test 400 when generation not complete"""
    response = client.get(f"/api/download/{test_session_pending.id}/zip")
    assert response.status_code == 400

def test_download_zip_not_found(client):
    """Test 404 for non-existent session"""
    response = client.get("/api/download/invalid-id/zip")
    assert response.status_code == 404
```

### Frontend Tests

```tsx
describe('Download All Button', () => {
  it('should download ZIP with all images', async () => {
    const mockBlob = new Blob(['test'], { type: 'application/zip' });
    jest.spyOn(apiClient, 'downloadZip').mockResolvedValue(mockBlob);

    const { getByText } = render(<DownloadAllButton />);

    fireEvent.click(getByText('Download All as ZIP'));

    await waitFor(() => {
      expect(apiClient.downloadZip).toHaveBeenCalledWith('abc-123');
    });
  });

  it('should be disabled when images still generating', () => {
    const { getByText } = render(<DownloadAllButton disabled={true} />);

    const button = getByText('Download All as ZIP').closest('button');
    expect(button).toBeDisabled();
  });

  it('should show loading state during download', async () => {
    jest.spyOn(apiClient, 'downloadZip').mockImplementation(
      () => new Promise(resolve => setTimeout(resolve, 1000))
    );

    const { getByText } = render(<DownloadAllButton />);

    fireEvent.click(getByText('Download All as ZIP'));

    expect(getByText('Creating ZIP...')).toBeInTheDocument();
  });
});
```

---

## ZIP File Structure

```
Organic_Sleep_Gummies_listing_images.zip
├── listing_main.png
├── listing_infographic_1.png
├── listing_infographic_2.png
├── listing_lifestyle.png
└── listing_comparison.png
```

---

## Error Handling

| Scenario | Response | User Message |
|----------|----------|--------------|
| Session not found | 404 | "Session expired or invalid" |
| Generation not complete | 400 | "Please wait for all images to finish" |
| Missing images | 400 | "Only X/5 images available" |
| File I/O error | 500 | "Server error creating ZIP" |
| Network timeout | Client timeout | "Download timed out. Try again or download individually" |

---

## Performance Considerations

- ZIP creation is done in-memory (fast for 5 images ~10MB total)
- Use `zipfile.ZIP_DEFLATED` for compression
- Streaming response for large ZIPs (future scalability)
- 2-minute timeout on frontend for slow networks
- Server-side caching of ZIPs (future optimization)

---

## Definition of Done

- [ ] Backend ZIP endpoint implemented
- [ ] Frontend Download All button working
- [ ] ZIP contains all 5 images with correct filenames
- [ ] ZIP filename based on product title
- [ ] Progress indicator shows during creation
- [ ] Works on desktop and mobile
- [ ] Error handling for all scenarios
- [ ] Backend tests passing
- [ ] Frontend tests passing
- [ ] ZIP file structure verified
- [ ] Performance tested (< 5 seconds for ZIP creation)
- [ ] Memory usage acceptable (< 100MB peak)
