# Implementation Story 4.4: Heatmap Optimization

**Epic:** Epic 4 - Keyword Intent System
**Story ID:** 4.4
**Story Title:** Optimize Image Composition for Visual Attention
**Priority:** Should Have
**Complexity:** Medium

---

## Story Overview

**User Story:**
As a user, I want my images optimized for where shoppers look first so that key elements capture attention immediately.

**Business Value:**
Applies eye-tracking research to ensure generated images place key selling points in high-attention zones, maximizing the effectiveness of each image in the Amazon listing.

---

## Acceptance Criteria

- [ ] Prompts include composition guidance based on eye-tracking heatmap data:
  - Primary focus zone: center-left for main product
  - Secondary zone: top-right for key benefit text
  - F-pattern reading flow for infographics
  - Mobile-first: larger elements, higher contrast
- [ ] Key selling points positioned in high-attention areas
- [ ] Text overlays placed in optimal reading zones
- [ ] Product positioned to maximize visual weight
- [ ] Negative space used strategically to direct attention

---

## Technical Context

### Mobile Amazon Browsing Heatmap (from Creative Blueprint)

```
┌─────────────────────────────────┐
│  ████ HIGH ATTENTION ZONE ████  │ ← Key benefit text (top 15%)
│                                 │
│     ┌───────────────────┐       │
│     │                   │       │
│     │     PRODUCT       │ ← Center-left focus
│     │    (Primary)      │   (40-60% vertical)
│     │                   │
│     └───────────────────┘       │
│                                 │
│  Supporting info / proof points │ ← F-pattern reading
└─────────────────────────────────┘   (bottom 25%)
```

### Composition Rules

| Zone | Content | Priority | Reasoning |
|------|---------|----------|-----------|
| **Top-Right (0-15% height)** | Key benefit headline | Primary | First eye fixation point on mobile |
| **Center-Left** | Main product visual | Primary | Maximum visual attention area |
| **Bottom-Left** | Supporting details | Secondary | F-pattern reading continuation |
| **Right Side** | Secondary elements | Tertiary | Less attention, good for subtle cues |
| **Negative Space** | Strategic emptiness | Critical | Directs eye flow, reduces cognitive load |

---

## Implementation Details

### Composition Rules System

```python
# prompts/composition_rules.py

"""
Composition guidance based on mobile Amazon browsing eye-tracking data.

Research shows mobile users follow an F-pattern with emphasis on:
- Top-right for initial attention (headline text)
- Center-left for primary visual (product)
- Bottom-left for additional details
"""

from typing import Dict, List

class CompositionRules:
    """
    Provides composition guidance for different image types based on
    eye-tracking heatmap research.
    """

    # Zone definitions (percentage of image height/width)
    ZONES = {
        'top_attention': {
            'vertical': (0, 15),      # Top 15% of image
            'horizontal': (40, 100),  # Right 60% of image
            'purpose': 'Primary headline text'
        },
        'center_left_hero': {
            'vertical': (30, 70),     # Middle 40% of image
            'horizontal': (0, 60),    # Left 60% of image
            'purpose': 'Main product placement'
        },
        'bottom_details': {
            'vertical': (75, 100),    # Bottom 25% of image
            'horizontal': (0, 70),    # Left 70% of image
            'purpose': 'Supporting information'
        },
        'negative_space': {
            'vertical': (0, 100),
            'horizontal': (60, 100),  # Right 40%
            'purpose': 'Visual breathing room'
        }
    }

    # Composition rules per image type
    INFOGRAPHIC_LAYOUT = """
[COMPOSITION HEATMAP OPTIMIZATION - INFOGRAPHIC]

Mobile-First Layout (based on eye-tracking data):

1. TOP-RIGHT ZONE (Primary Attention - 0-15% height):
   - Large, bold benefit headline
   - Maximum font size for mobile readability
   - High contrast against background
   - This captures initial eye fixation

2. CENTER-LEFT ZONE (Product Visual - 30-70% height, 0-60% width):
   - Product prominently placed
   - Maximum visual weight in this quadrant
   - Clear, uncluttered presentation
   - Draws eye naturally after headline

3. BOTTOM-LEFT ZONE (Supporting Details - 75-100% height):
   - Secondary benefit points
   - Supporting icons or checkmarks
   - Smaller text, but still legible
   - F-pattern reading continuation

4. NEGATIVE SPACE (Right 40%):
   - Minimal visual elements
   - Guides eye left-to-right flow
   - Prevents cognitive overload
   - Creates professional, clean look

CRITICAL MOBILE CONSIDERATIONS:
- All text must be legible at 400px width (thumbnail size)
- High contrast ratios (4.5:1 minimum for text)
- Larger elements than desktop designs
- Simple, scannable hierarchy
"""

    LIFESTYLE_LAYOUT = """
[COMPOSITION HEATMAP OPTIMIZATION - LIFESTYLE]

Mobile-First Natural Scene Composition:

1. RULE OF THIRDS - CENTER-LEFT EMPHASIS:
   - Product placement in left-center third
   - Follows natural eye movement pattern
   - Creates dynamic, engaging composition

2. FOCAL POINT PLACEMENT:
   - Primary subject (person using product) in center-left
   - Product visible but naturally integrated
   - Eye contact or directional gaze guides to product

3. DEPTH AND LAYERS:
   - Foreground: Product in use
   - Midground: Person/context
   - Background: Lifestyle setting (slightly blurred)
   - Creates visual journey through image

4. MOBILE CROPPING SAFETY:
   - All key elements within center 80% of frame
   - Account for different aspect ratio crops
   - No critical details near edges

LIFESTYLE-SPECIFIC RULES:
- Natural lighting emphasizes product
- Context supports use-case intent
- Authentic, not staged feeling
- Emotion visible in facial expression
"""

    MAIN_IMAGE_LAYOUT = """
[COMPOSITION HEATMAP OPTIMIZATION - MAIN IMAGE]

Premium Product Photography Composition:

1. CENTER-DOMINANT PLACEMENT (60-80% frame fill):
   - Product centered with slight left bias
   - Maximum visual presence
   - Symmetrical balance with dynamic interest

2. DYNAMIC STACKING (if applicable):
   - Main product: Center-front (largest)
   - Supporting element 1: Behind-right (medium)
   - Supporting element 2: Front-left (small accent)
   - Creates depth without cluttering

3. INGREDIENT POP PLACEMENT:
   - Accent elements (fruits, herbs): Diagonal arrangement
   - Supports center product without competing
   - Adds visual interest to negative space

4. LIGHTING HIERARCHY:
   - Brightest light on product center
   - Graduated falloff to edges
   - Creates natural focal point

AMAZON MAIN IMAGE SPECIFIC:
- Must stand out in search grid (compete with 20+ other images)
- Pure white background (#FFFFFF) non-negotiable
- Product clarity over artistic expression
- Works at both thumbnail and full size
"""

    COMPARISON_LAYOUT = """
[COMPOSITION HEATMAP OPTIMIZATION - COMPARISON CHART]

Two-Column Comparison Composition:

1. VERTICAL SPLIT LAYOUT:
   - Left column: "Our Product" (0-50% width)
   - Right column: "Generic" (50-100% width)
   - Clear visual separator line

2. TOP-TO-BOTTOM HIERARCHY:
   - Header row (0-20% height): Product images
   - Comparison rows (20-80% height): Feature points
   - Bottom row (80-100% height): Overall winner summary

3. VISUAL WEIGHT ASYMMETRY:
   - Left side (ours): Vibrant colors, larger checkmarks
   - Right side (theirs): Muted tones, smaller X-marks
   - Creates obvious winner without reading

4. COLOR PSYCHOLOGY ZONES:
   - Green checkmarks: Positive association, left side
   - Red/gray X-marks: Negative association, right side
   - Winner immediately obvious from color alone

MOBILE COMPARISON SPECIFIC:
- Large, clear checkmarks and X-marks
- Text readable at small size
- Overwhelming visual superiority on left
- Scannable in under 3 seconds
"""

    @classmethod
    def get_composition_guidance(cls, image_type: str) -> str:
        """
        Get composition guidance for a specific image type.

        Args:
            image_type: Type of image (main, infographic_1, etc.)

        Returns:
            Composition rules string to inject into prompt
        """
        if image_type in ['infographic_1', 'infographic_2']:
            return cls.INFOGRAPHIC_LAYOUT

        elif image_type == 'lifestyle':
            return cls.LIFESTYLE_LAYOUT

        elif image_type == 'main':
            return cls.MAIN_IMAGE_LAYOUT

        elif image_type == 'comparison':
            return cls.COMPARISON_LAYOUT

        else:
            return ""

    @classmethod
    def get_mobile_first_rules(cls) -> str:
        """Get universal mobile-first composition rules"""
        return """
[MOBILE-FIRST DESIGN RULES]

1. THUMBNAIL LEGIBILITY TEST:
   - All text readable at 400px width
   - Key elements identifiable at 200px
   - High contrast for small screens

2. SINGLE MESSAGE FOCUS:
   - One primary message per image
   - Remove all non-essential elements
   - Clear visual hierarchy

3. BOLD & SIMPLE:
   - Larger fonts than desktop
   - Higher contrast ratios
   - Minimal visual complexity

4. TOUCH-FRIENDLY THINKING:
   - Large, clear focal points
   - No tiny details required to understand
   - Works at arm's length viewing

5. FAST COMPREHENSION:
   - Message clear in under 2 seconds
   - No reading required to get main point
   - Visual storytelling over text
"""

    @classmethod
    def get_f_pattern_guidance(cls) -> str:
        """Get F-pattern reading flow guidance for infographics"""
        return """
[F-PATTERN READING FLOW]

Based on eye-tracking research, users scan infographics in an F-pattern:

Step 1: HORIZONTAL TOP (Primary)
- User reads headline text (top-right)
- This is where benefit statement goes
- Maximum attention zone

Step 2: VERTICAL LEFT (Secondary)
- Eye drops down left side
- Product visual should be here
- Supporting visual elements

Step 3: HORIZONTAL MIDDLE (Tertiary)
- Secondary text or icons
- Additional benefit points
- Smaller, supporting information

Step 4: VERTICAL LEFT AGAIN (Scannable)
- Final details, if needed
- Less critical information
- User may skip this zone

DESIGN IMPLICATIONS:
- Most important content: Top and left
- Least important content: Bottom-right
- Text alignment: Left-aligned for scannability
- Visual anchors: Along left edge
"""
```

---

### Updated Prompt Engine with Composition Rules

```python
# prompts/engine.py (Update to include composition guidance)

from .composition_rules import CompositionRules

class PromptEngine:
    """Constructs prompts for each image type with intent injection and composition rules"""

    def __init__(self):
        self.templates = {
            'main': main_image.TEMPLATE,
            'infographic_1': infographic.TEMPLATE_1,
            'infographic_2': infographic.TEMPLATE_2,
            'lifestyle': lifestyle.TEMPLATE,
            'comparison': comparison.TEMPLATE,
        }
        self.composition_rules = CompositionRules()

    def build_prompt(
        self,
        image_type: str,
        context: ProductContext
    ) -> str:
        """
        Build a complete prompt for the specified image type.

        Includes:
        - Base template
        - Intent modifiers
        - Composition/heatmap guidance
        - Mobile-first rules
        """
        # Get base template
        template = self.templates[image_type]

        # Get intent modifiers for this image type
        intent_modifiers = get_intent_modifiers(image_type, context.intents)

        # Build intent context
        intent_context = build_intent_context(context.intents, image_type)

        # Get composition guidance
        composition_guidance = self.composition_rules.get_composition_guidance(image_type)

        # Get mobile-first rules (for infographics and comparison)
        mobile_rules = ""
        if image_type in ['infographic_1', 'infographic_2', 'comparison']:
            mobile_rules = self.composition_rules.get_mobile_first_rules()

        # Get F-pattern guidance (for infographics only)
        f_pattern_guidance = ""
        if image_type in ['infographic_1', 'infographic_2']:
            f_pattern_guidance = self.composition_rules.get_f_pattern_guidance()

        # ... rest of variable building (from Story 4.3)

        variables = {
            # ... existing variables from Story 4.3
            'composition_guidance': composition_guidance,
            'mobile_rules': mobile_rules,
            'f_pattern_guidance': f_pattern_guidance,
        }

        # Render template
        prompt = template.format(**variables)

        return prompt
```

---

### Updated Infographic Template with Composition

```python
# prompts/templates/infographic.py (Updated)

TEMPLATE_1 = """
Create an Amazon infographic image highlighting a key benefit.

[REFERENCE IMAGE]
Use the provided product photo for accurate product representation.

[PRODUCT CONTEXT]
Product: {product_title}
Key Benefit: {feature_1}
Target Audience: {target_audience}

{composition_guidance}

{f_pattern_guidance}

{mobile_rules}

[STYLE DIRECTION]
- Modern, clean infographic design
- Benefit-focused language (e.g., "Sleep Better" not "10mg Melatonin")
- Color palette matching product aesthetic
- Professional but approachable

[INTENT ALIGNMENT]
{intent_modifiers}

[PROBLEM/SOLUTION FOCUS]
{intent_context}

[KEYWORD ALIGNMENT]
Top keywords: {top_keywords}
Ensure visual elements prove the claims implied by these search terms.

[TECHNICAL REQUIREMENTS]
- Resolution: 2000x2000px
- Text readable at mobile thumbnail size (400px width)
- Benefit headline must be immediately clear
- High contrast ratios (4.5:1 minimum)

Generate an infographic optimized for mobile Amazon browsing patterns.
Headline in top-right, product center-left, details bottom-left.
"""
```

---

## Testing Requirements

### Unit Tests

```python
# tests/unit/test_composition_prompts.py

import pytest
from app.prompts.composition_rules import CompositionRules

def test_infographic_composition_includes_zones():
    """Test that infographic composition includes zone guidance"""
    guidance = CompositionRules.get_composition_guidance('infographic_1')

    assert 'TOP-RIGHT ZONE' in guidance
    assert 'CENTER-LEFT ZONE' in guidance
    assert 'BOTTOM-LEFT ZONE' in guidance
    assert 'NEGATIVE SPACE' in guidance

def test_mobile_first_rules_included():
    """Test that mobile-first rules are comprehensive"""
    rules = CompositionRules.get_mobile_first_rules()

    assert 'THUMBNAIL LEGIBILITY' in rules
    assert '400px width' in rules
    assert 'High contrast' in rules.lower()

def test_f_pattern_guidance_comprehensive():
    """Test that F-pattern guidance is detailed"""
    guidance = CompositionRules.get_f_pattern_guidance()

    assert 'HORIZONTAL TOP' in guidance
    assert 'VERTICAL LEFT' in guidance
    assert 'eye-tracking' in guidance.lower()

def test_composition_rules_for_all_types():
    """Test that all image types have composition rules"""
    types = ['main', 'infographic_1', 'infographic_2', 'lifestyle', 'comparison']

    for image_type in types:
        guidance = CompositionRules.get_composition_guidance(image_type)
        assert len(guidance) > 0, f"No composition rules for {image_type}"
```

---

## Quality Checklist

Before marking this story complete, verify generated images against this checklist:

### Infographics
- [ ] Headline text clearly visible in top-right quadrant
- [ ] Product image placed in center-left area
- [ ] Supporting details in bottom-left (if any)
- [ ] Right side has negative space (not cluttered)
- [ ] Text legible at 400px width
- [ ] High contrast (4.5:1 ratio minimum)

### Main Image
- [ ] Product centered with slight left bias
- [ ] Occupies 60-80% of frame
- [ ] If stacked, follows diagonal arrangement
- [ ] Brightest lighting on product center
- [ ] Stands out in search grid view

### Lifestyle
- [ ] Product/person in left-center third
- [ ] Natural rule-of-thirds composition
- [ ] All key elements in center 80% (safe zone)
- [ ] Depth through foreground/midground/background layers

### Comparison
- [ ] Clear left-right split (50/50)
- [ ] "Our product" (left) more visually prominent
- [ ] Color psychology applied (green left, red/gray right)
- [ ] Scannable in under 3 seconds

---

## Dependencies

- **Upstream:** Story 4.3 (Intent-Aligned Image Generation)
- **Related:** Story 2.1b (Prompt Engineering System)

---

## Definition of Done

- [ ] Composition rules defined for all 5 image types
- [ ] Mobile-first guidance included in prompts
- [ ] F-pattern reading flow applied to infographics
- [ ] Heatmap zones defined with percentages
- [ ] Composition guidance integrated into PromptEngine
- [ ] All templates updated with composition placeholders
- [ ] Unit tests validate composition rules present
- [ ] Quality checklist created for visual validation
- [ ] Documentation includes heatmap diagram
- [ ] QA manually validates composition in sample images

---

## Example Composition Guidance Output

### Infographic Prompt with Heatmap Optimization

```
Create an Amazon infographic image highlighting a key benefit.

[REFERENCE IMAGE]
Use the provided product photo for accurate product representation.

[PRODUCT CONTEXT]
Product: Organic Sleep Gummies
Key Benefit: All-natural melatonin
Target Audience: Busy professionals seeking better sleep

[COMPOSITION HEATMAP OPTIMIZATION - INFOGRAPHIC]

Mobile-First Layout (based on eye-tracking data):

1. TOP-RIGHT ZONE (Primary Attention - 0-15% height):
   - Large, bold benefit headline: "SLEEP BETTER NATURALLY"
   - Maximum font size for mobile readability
   - High contrast against background
   - This captures initial eye fixation

2. CENTER-LEFT ZONE (Product Visual - 30-70% height, 0-60% width):
   - Product prominently placed
   - Maximum visual weight in this quadrant
   - Clear, uncluttered presentation
   - Draws eye naturally after headline

3. BOTTOM-LEFT ZONE (Supporting Details - 75-100% height):
   - Secondary benefit points (icons/checkmarks)
   - Supporting text: "Non-habit forming"
   - Smaller text, but still legible
   - F-pattern reading continuation

4. NEGATIVE SPACE (Right 40%):
   - Minimal visual elements
   - Guides eye left-to-right flow
   - Prevents cognitive overload
   - Creates professional, clean look

[F-PATTERN READING FLOW]

Step 1: HORIZONTAL TOP (Primary)
- User reads headline text (top-right): "SLEEP BETTER NATURALLY"

Step 2: VERTICAL LEFT (Secondary)
- Eye drops down left side to product image

Step 3: HORIZONTAL MIDDLE (Tertiary)
- Supporting icons or benefit points

[MOBILE-FIRST DESIGN RULES]

- All text readable at 400px width (thumbnail size)
- High contrast ratios (4.5:1 minimum)
- Single message focus: Natural sleep solution
- Bold, simple design

[TECHNICAL REQUIREMENTS]
- Resolution: 2000x2000px
- Text readable at mobile thumbnail size
- Benefit headline immediately clear

Generate an infographic optimized for mobile Amazon browsing patterns.
Headline in top-right, product center-left, details bottom-left.
```

---

## Notes

- Composition optimization is based on actual eye-tracking research for Amazon mobile browsing
- This is a "should have" feature - adds polish but not critical for MVP
- Can be implemented after core intent system (4.1-4.3) is working
- Visual validation tests are aspirational - manual QA sufficient for MVP
- Future: Could use computer vision to auto-validate composition adherence
- Heatmap percentages are approximate guidelines, not rigid requirements
- The composition rules enhance but don't replace intent alignment from Story 4.3
