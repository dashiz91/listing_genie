# Story 1.5: Development Environment Setup

**Phase:** 1 - Foundation
**Story ID:** 1.5
**Title:** Set Up Docker Development Environment
**Priority:** Must Have
**Complexity:** Medium
**Status:** Ready for Development

---

## User Story

As a developer, I need a Docker-based development environment with hot reload for both backend and frontend so that I can develop efficiently.

---

## Acceptance Criteria

- [ ] Dockerfile with multi-stage build (frontend + backend)
- [ ] docker-compose.yml for local development
- [ ] Hot reload working for backend (uvicorn --reload)
- [ ] Hot reload working for frontend (Vite HMR)
- [ ] Environment variable handling via .env
- [ ] Single command to start entire stack (docker-compose up)
- [ ] Volumes configured for code changes to reflect immediately

---

## Project Structure (IMPLEMENT THIS)

```
listing_genie/
├── Dockerfile                # Production build
├── Dockerfile.dev            # Development build
├── docker-compose.yml        # Development orchestration
├── .env.example              # Environment variables template
├── .dockerignore             # Docker ignore file
└── README.md                 # UPDATE with Docker instructions
```

---

## Code to Implement

### Dockerfile (Production)

```dockerfile
# ============================================
# Stage 1: Build Frontend
# ============================================
FROM node:20-alpine AS frontend-builder

WORKDIR /frontend

# Install dependencies
COPY frontend/package.json frontend/package-lock.json ./
RUN npm ci

# Build production assets
COPY frontend/ ./
RUN npm run build

# ============================================
# Stage 2: Python Application
# ============================================
FROM python:3.11-slim AS production

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY app/ ./app/
COPY --from=frontend-builder /frontend/dist ./frontend/dist

# Create storage directories
RUN mkdir -p storage/uploads storage/generated

# Create non-root user
RUN useradd --create-home --shell /bin/bash appuser && \
    chown -R appuser:appuser /app
USER appuser

# Expose port
EXPOSE 8000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"

# Run application
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

### Dockerfile.dev (Development)

```dockerfile
FROM python:3.11-slim

# Environment
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1

WORKDIR /app

# Install system dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc \
    libpq-dev \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install development dependencies
RUN pip install --no-cache-dir \
    pytest \
    pytest-asyncio \
    httpx

# Create storage directories
RUN mkdir -p storage/uploads storage/generated

# Create non-root user
RUN useradd --create-home --shell /bin/bash appuser && \
    chown -R appuser:appuser /app
USER appuser

EXPOSE 8000

# Development server with hot reload
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
```

### docker-compose.yml

```yaml
version: '3.8'

services:
  # Backend API
  backend:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: listing-genie-backend
    ports:
      - "8000:8000"
    environment:
      - DEBUG=true
      - DATABASE_URL=sqlite:///./listing_genie.db
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - STORAGE_PATH=/app/storage
      - CORS_ORIGINS=["http://localhost:5173","http://localhost:3000"]
    volumes:
      - ./app:/app/app:ro              # Backend code (hot reload)
      - ./storage:/app/storage         # Persistent storage
      - ./listing_genie.db:/app/listing_genie.db  # Database
    networks:
      - listing-genie-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Frontend
  frontend:
    image: node:20-alpine
    container_name: listing-genie-frontend
    working_dir: /app
    ports:
      - "5173:5173"
    environment:
      - VITE_API_URL=http://localhost:8000/api
    volumes:
      - ./frontend:/app:cached         # Frontend code (hot reload)
      - /app/node_modules              # Prevent overwriting node_modules
    command: sh -c "npm install && npm run dev -- --host"
    networks:
      - listing-genie-network
    depends_on:
      - backend

  # PostgreSQL (Optional - for production-like testing)
  # Uncomment to use PostgreSQL instead of SQLite
  # db:
  #   image: postgres:15-alpine
  #   container_name: listing-genie-db
  #   environment:
  #     POSTGRES_USER: listing_genie
  #     POSTGRES_PASSWORD: development
  #     POSTGRES_DB: listing_genie
  #   volumes:
  #     - postgres_data:/var/lib/postgresql/data
  #   ports:
  #     - "5432:5432"
  #   networks:
  #     - listing-genie-network

networks:
  listing-genie-network:
    driver: bridge

# volumes:
#   postgres_data:
```

### .dockerignore

```
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
venv/
env/
*.egg-info/

# Node
node_modules/
dist/
build/

# Environment
.env
.env.local

# Database
*.db
*.sqlite

# Storage
storage/

# IDE
.vscode/
.idea/
*.swp
*.swo

# Git
.git/
.gitignore

# Documentation
docs/
README.md

# Tests
tests/
__tests__/
*.test.js
*.test.ts
*.spec.js
*.spec.ts

# Misc
.DS_Store
Thumbs.db
```

### .env.example (COMPLETE VERSION)

```bash
# ======================
# Application Settings
# ======================
DEBUG=true
SECRET_KEY=your-secret-key-here-change-in-production

# ======================
# API Keys
# ======================
GEMINI_API_KEY=your-gemini-api-key-here

# ======================
# Database
# ======================
# SQLite (Development)
DATABASE_URL=sqlite:///./listing_genie.db

# PostgreSQL (Production)
# DATABASE_URL=postgresql://user:password@db:5432/listing_genie

# ======================
# Storage
# ======================
STORAGE_PATH=./storage

# ======================
# CORS
# ======================
CORS_ORIGINS=["http://localhost:5173","http://localhost:3000"]

# ======================
# Frontend (Vite)
# ======================
VITE_API_URL=http://localhost:8000/api
```

### README.md (UPDATE - Add Development Section)

```markdown
# Listing Genie

AI-powered Amazon listing image generator.

## Quick Start (Docker)

### Prerequisites

- Docker Desktop installed
- Gemini API key ([Get one here](https://ai.google.dev/))

### Setup

1. Clone the repository:
```bash
git clone <repo-url>
cd listing_genie
```

2. Create `.env` file:
```bash
cp .env.example .env
# Edit .env and add your GEMINI_API_KEY
```

3. Start the application:
```bash
docker-compose up
```

4. Access the application:
- Frontend: http://localhost:5173
- Backend API: http://localhost:8000
- API Docs: http://localhost:8000/docs

### Development Workflow

**Hot Reload Enabled:** Code changes automatically reload both frontend and backend.

**Backend Development:**
```bash
# Logs
docker-compose logs -f backend

# Run tests
docker-compose exec backend pytest

# Access Python shell
docker-compose exec backend python
```

**Frontend Development:**
```bash
# Logs
docker-compose logs -f frontend

# Install new package
docker-compose exec frontend npm install <package-name>

# Run linter
docker-compose exec frontend npm run lint
```

**Rebuild containers:**
```bash
docker-compose down
docker-compose build
docker-compose up
```

## Local Development (Without Docker)

### Backend

```bash
# Create virtual environment
python -m venv venv
source venv/bin/activate  # On Windows: venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt

# Run server
uvicorn app.main:app --reload
```

### Frontend

```bash
cd frontend
npm install
npm run dev
```

## Project Structure

```
listing_genie/
├── app/                 # Backend (FastAPI)
├── frontend/            # Frontend (React + Vite)
├── storage/             # File storage (gitignored)
├── docs/                # Documentation
├── tests/               # Tests
└── docker-compose.yml   # Development environment
```

## Testing

```bash
# Backend tests
docker-compose exec backend pytest

# Frontend tests (when implemented)
docker-compose exec frontend npm test
```

## Deployment

See [deployment guide](docs/deployment.md) for production deployment instructions.

## License

MIT
```

### Makefile (OPTIONAL - Nice to have)

```makefile
.PHONY: help start stop restart logs build clean test

help:
	@echo "Listing Genie Development Commands"
	@echo "-----------------------------------"
	@echo "make start    - Start all services"
	@echo "make stop     - Stop all services"
	@echo "make restart  - Restart all services"
	@echo "make logs     - View logs"
	@echo "make build    - Rebuild containers"
	@echo "make clean    - Remove containers and volumes"
	@echo "make test     - Run tests"

start:
	docker-compose up -d

stop:
	docker-compose down

restart:
	docker-compose restart

logs:
	docker-compose logs -f

build:
	docker-compose build

clean:
	docker-compose down -v
	rm -rf storage/*
	rm -f *.db

test:
	docker-compose exec backend pytest
```

---

## Test Gate (Must Pass Before Phase 2)

```bash
# Create .env file
cp .env.example .env
# Add your GEMINI_API_KEY to .env

# Start services
docker-compose up

# Wait for services to start (watch logs)
# Expected: Both backend and frontend start successfully

# Test backend
curl http://localhost:8000/health
# Expected: {"status": "healthy", "service": "listing-genie"}

# Test frontend (browser)
# Open http://localhost:5173
# Expected: Landing page loads

# Test hot reload - Backend
# Edit app/main.py - change health response
# Save file
# curl http://localhost:8000/health
# Expected: See your changes immediately

# Test hot reload - Frontend
# Edit frontend/src/pages/LandingPage.tsx - change heading text
# Save file
# Refresh browser
# Expected: See your changes immediately

# Test health check
docker-compose exec backend curl http://localhost:8000/api/health
# Expected: Returns database and storage status

# View logs
docker-compose logs backend
docker-compose logs frontend
# Expected: No errors, clean startup

# Stop services
docker-compose down
# Expected: Clean shutdown
```

---

## Dependencies

- **Depends On:** 1.1, 1.2, 1.3, 1.4 (All foundation pieces)
- **Blocks:** Phase 2 development (need working dev environment)

---

## Definition of Done

- [ ] Dockerfile builds successfully
- [ ] Dockerfile.dev builds successfully
- [ ] docker-compose up starts both services
- [ ] Backend accessible at localhost:8000
- [ ] Frontend accessible at localhost:5173
- [ ] Hot reload works for backend (Python changes auto-reload)
- [ ] Hot reload works for frontend (React changes auto-reload)
- [ ] Health endpoints return success
- [ ] API documentation loads at /docs
- [ ] Frontend can call backend API
- [ ] No errors in docker-compose logs
- [ ] README.md updated with Docker instructions
- [ ] .env.example includes all required variables
- [ ] .dockerignore properly excludes unnecessary files

---

## Notes for Developer

1. **Multi-Stage Build:** Production Dockerfile builds frontend then copies to backend
2. **Hot Reload:** Development uses volumes to mount source code
3. **Node Modules:** Frontend volume excludes node_modules to prevent conflicts
4. **Database:** Using SQLite for development, easy to switch to PostgreSQL
5. **Health Checks:** Docker health checks ensure services are ready
6. **Makefile:** Optional but provides convenient shortcuts
7. **Network:** All services on same Docker network for inter-service communication
8. **User:** Running as non-root user for security
9. **Environment:** All config via environment variables for 12-factor app pattern
10. **Production:** Dockerfile is production-ready, docker-compose.yml is dev-only
