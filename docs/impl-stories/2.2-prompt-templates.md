# Story 2.2: Prompt Template System

**Epic:** Phase 2 - AI Core
**Priority:** Must Have
**Complexity:** Large
**Status:** Ready for Implementation

---

## User Story

As the system, I need a prompt engineering system based on the Creative Blueprint so that generated images follow high-conversion Amazon listing best practices.

---

## Acceptance Criteria

- [ ] Prompt templates implement Creative Blueprint guidelines (docs/creative-blueprint.md)
- [ ] Main Image prompt includes: dynamic composition, stacking, ingredient pop, premium textures
- [ ] Infographic prompts include: benefit-focused headlines, bold text, <20% text density
- [ ] Lifestyle prompt includes: Instagram aesthetic, target audience matching, emotional resonance
- [ ] Comparison prompt includes: check vs. X format, color psychology, clear winner hierarchy
- [ ] All prompts pass uploaded product photo as reference image
- [ ] Prompts inject product title, features, and target audience dynamically
- [ ] Color palette selected based on product category
- [ ] Prompt templates stored as configurable files (easy to iterate/improve)
- [ ] Test: Templates load and populate with test data

---

## Implementation Details

### 1. Create Prompt Template Structure

Create directory structure:
```
app/prompts/
├── __init__.py
├── engine.py              # Main PromptEngine class
├── templates/
│   ├── __init__.py
│   ├── main_image.py      # Main image template
│   ├── infographic.py     # Infographic templates (1 & 2)
│   ├── lifestyle.py       # Lifestyle template
│   └── comparison.py      # Comparison chart template
├── intent_modifiers.py    # Intent classification and injection
└── color_psychology.py    # Category-based color recommendations
```

### 2. Create Main Image Template

Create `app/prompts/templates/main_image.py`:

```python
"""
Main Product Image Prompt Template
Based on Creative Blueprint Section 1
"""

TEMPLATE = """
Create a premium Amazon main product image.

[REFERENCE IMAGE]
Use the provided product photo as the base reference.
Maintain product accuracy while applying creative direction.

[PRODUCT CONTEXT]
Product: {product_title}
Key Benefit: {key_feature}
Target Audience: {target_audience}

[COMPOSITION REQUIREMENTS]
- Pure white background (#FFFFFF)
- Product fills 85% of frame
- Use dynamic "stacking" composition with depth
- If applicable, show ingredient elements (fruits, herbs, etc.) arranged aesthetically
- Professional studio lighting with subtle natural shadows
- Premium, tactile texture quality

[STYLE DIRECTION]
- High-end commercial product photography
- Visually "dense" and interesting
- Must stand out in Amazon search results grid
- No text, logos, or watermarks

[INTENT ALIGNMENT]
{intent_modifiers}

[TECHNICAL REQUIREMENTS]
- Resolution: 2000x2000px minimum
- Format: PNG with RGB color mode
- Amazon compliant: white background, product-focused

Enhance and stage the product, do not alter the product itself.
"""
```

### 3. Create Infographic Templates

Create `app/prompts/templates/infographic.py`:

```python
"""
Infographic Image Prompt Templates
Based on Creative Blueprint Section 2
"""

TEMPLATE_1 = """
Create an Amazon infographic image highlighting a key benefit.

[REFERENCE IMAGE]
Use the provided product photo for accurate product representation.

[PRODUCT CONTEXT]
Product: {product_title}
Key Benefit: {feature_1}
Target Audience: {target_audience}

[COMPOSITION REQUIREMENTS]
- Product visible and prominent (center-left placement)
- Large, bold headline text highlighting the benefit
- Text is a DESIGN element, not just a caption
- High-contrast, legible at thumbnail size
- Text covers less than 20% of image area
- F-pattern reading flow consideration

[STYLE DIRECTION]
- Modern, clean infographic design
- Benefit-focused language (e.g., "Sleep Better" not "10mg Melatonin")
- Color palette matching product aesthetic
- Professional but approachable

[INTENT ALIGNMENT]
{intent_modifiers}

[KEYWORD ALIGNMENT]
Top keywords: {top_keywords}
Ensure visual elements prove the claims implied by these search terms.

[TECHNICAL REQUIREMENTS]
- Resolution: 2000x2000px
- Text readable at mobile thumbnail size
"""

TEMPLATE_2 = """
Create an Amazon infographic image highlighting a secondary key benefit.

[REFERENCE IMAGE]
Use the provided product photo for accurate product representation.

[PRODUCT CONTEXT]
Product: {product_title}
Key Benefit: {feature_2}
Target Audience: {target_audience}

[COMPOSITION REQUIREMENTS]
- Product visible and prominent
- Large, bold headline text highlighting the benefit
- Text as design element with visual hierarchy
- High-contrast for mobile visibility
- Text density under 20%

[STYLE DIRECTION]
- Consistent with first infographic styling
- Different visual approach to avoid repetition
- Benefit-focused messaging
- Modern, scannable layout

[INTENT ALIGNMENT]
{intent_modifiers}

[TECHNICAL REQUIREMENTS]
- Resolution: 2000x2000px
- Maintains visual cohesion with other listing images
"""
```

### 4. Create Lifestyle Template

Create `app/prompts/templates/lifestyle.py`:

```python
"""
Lifestyle Image Prompt Template
Based on Creative Blueprint Section 2
"""

TEMPLATE = """
Create an Instagram-style lifestyle image for Amazon.

[REFERENCE IMAGE]
Use the provided product photo. Show it being used naturally in context.

[PRODUCT CONTEXT]
Product: {product_title}
Target Audience: {target_audience}
Key Features: {feature_1}, {feature_2}

[COMPOSITION REQUIREMENTS]
- Authentic, real-world setting
- Person using/enjoying product matches target demographic
- Warm, natural lighting (sunlit room, outdoor, etc.)
- Product clearly visible but naturally integrated
- Aspirational but relatable scene

[STYLE DIRECTION]
- High-end social media aesthetic
- Warm, inviting, authentic feel
- NOT clinical or stock-photo looking
- Model expression shows positive result of using product
- Emotional resonance with target audience

[INTENT ALIGNMENT]
{intent_modifiers}

[USE CASE VISUALIZATION]
Based on target audience "{target_audience}", show the product in a context
that matches their lifestyle and usage patterns.

[TECHNICAL REQUIREMENTS]
- Resolution: 2000x2000px
- Natural color grading
- Lifestyle context appropriate for product category
"""
```

### 5. Create Comparison Template

Create `app/prompts/templates/comparison.py`:

```python
"""
Comparison Chart Prompt Template
Based on Creative Blueprint Section 2
"""

TEMPLATE = """
Create a comparison chart image for Amazon.

[REFERENCE IMAGE]
Use the provided product photo on the "our product" side.
Represent competitor as generic/unnamed alternative.

[PRODUCT CONTEXT]
Product: {product_title}
Our Advantages: {feature_2}, {feature_3}

[COMPOSITION REQUIREMENTS]
- "Us vs. Them" two-column layout
- Our product: vibrant colors, checkmarks (green)
- Generic competitor: muted/greyscale, X-marks (red/grey)
- 3-4 comparison points based on features
- Clear visual hierarchy showing our product as winner

[STYLE DIRECTION]
- Professional infographic design
- Strong color contrast (green vs. red/grey)
- Text legible at thumbnail size
- Color psychology: warm/positive for us, cool/negative for them

[INTENT ALIGNMENT]
{intent_modifiers}

[COMPARISON POINTS]
1. {feature_2} (Us: Yes, Them: No)
2. {feature_3} (Us: Yes, Them: Limited)
3. Quality/Premium (Us: Superior, Them: Basic)

[TECHNICAL REQUIREMENTS]
- Resolution: 2000x2000px
- Clear, scannable layout
- Winner should be immediately obvious
"""
```

### 6. Create Intent Modifiers System

Create `app/prompts/intent_modifiers.py`:

```python
"""
Keyword Intent Modifiers for Visual Proof
Based on Creative Blueprint Section 5
"""
from typing import Dict, List

INTENT_VISUAL_PROOF = {
    'durability': [
        "Show rugged, premium materials and construction quality",
        "Emphasize durability through visual texture and build quality",
        "Include visual cues suggesting long-lasting performance",
    ],
    'use_case': [
        "Show product in the exact context implied by search terms",
        "Visualize the specific use case scenario",
        "Environment should match intended usage",
    ],
    'style': [
        "Match visual aesthetic to style-related keywords",
        "Color palette and composition should reflect style intent",
        "Design elements should resonate with aesthetic preferences",
    ],
    'problem_solution': [
        "Visualize the solved state / positive outcome",
        "Show relief, satisfaction, or resolution",
        "Before/after or transformation visual if appropriate",
    ],
    'comparison': [
        "Emphasize superiority and premium positioning",
        "Clear winner hierarchy in visual presentation",
        "Quality differentiation should be obvious",
    ],
}

IMAGE_TYPE_INTENT_PRIORITY = {
    'main': ['durability', 'style'],
    'infographic_1': ['problem_solution', 'durability'],
    'infographic_2': ['problem_solution', 'use_case'],
    'lifestyle': ['use_case', 'style'],
    'comparison': ['comparison', 'durability'],
}

def get_intent_modifiers(
    image_type: str,
    keyword_intents: Dict[str, List[str]]
) -> str:
    """
    Generate intent-specific prompt modifiers for an image type.

    Args:
        image_type: The type of image being generated
        keyword_intents: Mapping of keywords to their classified intents

    Returns:
        String of intent modifiers to inject into the prompt
    """
    # Collect all unique intents from keywords
    all_intents = set()
    for intents in keyword_intents.values():
        all_intents.update(intents)

    # Get priority intents for this image type
    priority_intents = IMAGE_TYPE_INTENT_PRIORITY.get(image_type, [])

    # Build modifier string
    modifiers = []
    for intent in priority_intents:
        if intent in all_intents:
            proof_statements = INTENT_VISUAL_PROOF.get(intent, [])
            if proof_statements:
                modifiers.append(f"[{intent.upper()} INTENT]")
                modifiers.extend(f"- {stmt}" for stmt in proof_statements)

    if not modifiers:
        return "Focus on professional product presentation and visual appeal."

    return '\n'.join(modifiers)
```

### 7. Create Color Psychology Module

Create `app/prompts/color_psychology.py`:

```python
"""
Color Psychology for Product Categories
Based on Creative Blueprint Section 4
"""
from typing import List

CATEGORY_PALETTES = {
    'health_supplements': {
        'primary': ['earthy greens', 'natural browns', 'soft whites'],
        'accent': ['gold', 'amber'],
        'mood': 'natural, trustworthy, organic'
    },
    'fitness': {
        'primary': ['bold blacks', 'energetic reds', 'electric blues'],
        'accent': ['neon green', 'orange'],
        'mood': 'powerful, energetic, motivating'
    },
    'baby_kids': {
        'primary': ['soft pastels', 'warm yellows', 'gentle blues'],
        'accent': ['white', 'cream'],
        'mood': 'safe, gentle, nurturing'
    },
    'tech_electronics': {
        'primary': ['deep blues', 'clean whites', 'sleek grays'],
        'accent': ['electric blue', 'silver'],
        'mood': 'modern, innovative, premium'
    },
    'home_kitchen': {
        'primary': ['warm neutrals', 'natural wood tones', 'white'],
        'accent': ['copper', 'brass', 'green'],
        'mood': 'warm, inviting, reliable'
    },
    'default': {
        'primary': ['professional blues', 'clean whites'],
        'accent': ['gold', 'green'],
        'mood': 'professional, trustworthy'
    }
}

def get_color_guidance(category: str) -> str:
    """Generate color palette guidance for prompts"""
    palette = CATEGORY_PALETTES.get(category, CATEGORY_PALETTES['default'])

    return f"""
[COLOR PSYCHOLOGY]
- Primary palette: {', '.join(palette['primary'])}
- Accent colors: {', '.join(palette['accent'])}
- Overall mood: {palette['mood']}
"""

def infer_category(product_title: str, keywords: List[str]) -> str:
    """Infer product category from title and keywords"""
    title_lower = product_title.lower()
    keywords_lower = [k.lower() for k in keywords]
    all_text = title_lower + ' ' + ' '.join(keywords_lower)

    category_keywords = {
        'health_supplements': ['vitamin', 'supplement', 'gummy', 'organic', 'natural', 'health'],
        'fitness': ['fitness', 'workout', 'gym', 'protein', 'exercise', 'sport'],
        'baby_kids': ['baby', 'kid', 'child', 'infant', 'toddler', 'nursery'],
        'tech_electronics': ['tech', 'electronic', 'gadget', 'smart', 'device', 'digital'],
        'home_kitchen': ['kitchen', 'home', 'cooking', 'utensil', 'organizer', 'storage'],
    }

    for category, keywords in category_keywords.items():
        if any(kw in all_text for kw in keywords):
            return category

    return 'default'
```

### 8. Create Prompt Engine

Create `app/prompts/engine.py`:

```python
"""
Prompt Engineering Engine
Based on Architecture Document Section 6
"""
from typing import Dict, List
from dataclasses import dataclass
from .templates import main_image, infographic, lifestyle, comparison
from .intent_modifiers import get_intent_modifiers
from .color_psychology import get_color_guidance, infer_category

@dataclass
class ProductContext:
    title: str
    features: List[str]
    target_audience: str
    keywords: List[str]
    intents: Dict[str, List[str]]  # keyword -> list of intent types

class PromptEngine:
    """Constructs prompts for each image type with intent injection"""

    def __init__(self):
        self.templates = {
            'main': main_image.TEMPLATE,
            'infographic_1': infographic.TEMPLATE_1,
            'infographic_2': infographic.TEMPLATE_2,
            'lifestyle': lifestyle.TEMPLATE,
            'comparison': comparison.TEMPLATE,
        }

    def build_prompt(
        self,
        image_type: str,
        context: ProductContext
    ) -> str:
        """
        Build a complete prompt for the specified image type.

        Args:
            image_type: One of main, infographic_1, infographic_2, lifestyle, comparison
            context: Product information and keyword intents

        Returns:
            Complete prompt string ready for Gemini API
        """
        # Get base template
        template = self.templates[image_type]

        # Get intent modifiers for this image type
        intent_modifiers = get_intent_modifiers(image_type, context.intents)

        # Infer category and get color guidance
        category = infer_category(context.title, context.keywords)
        color_guidance = get_color_guidance(category)

        # Select appropriate features for this image type
        feature_mapping = {
            'main': context.features[0],
            'infographic_1': context.features[0],
            'infographic_2': context.features[1],
            'lifestyle': context.target_audience,
            'comparison': f"{context.features[1]}, {context.features[2]}",
        }

        # Build the prompt
        prompt = template.format(
            product_title=context.title,
            key_feature=feature_mapping.get(image_type, context.features[0]),
            feature_1=context.features[0],
            feature_2=context.features[1],
            feature_3=context.features[2],
            target_audience=context.target_audience,
            intent_modifiers=intent_modifiers,
            top_keywords=', '.join(context.keywords[:5])
        )

        # Append color guidance if applicable
        if image_type in ['lifestyle', 'infographic_1', 'infographic_2']:
            prompt += f"\n\n{color_guidance}"

        return prompt
```

---

## Testing Instructions

### 1. Create Test File

Create `tests/test_prompt_templates.py`:

```python
"""
Test Prompt Template System
"""
import pytest
from app.prompts.engine import PromptEngine, ProductContext

def test_template_loading():
    """Test that all templates load correctly"""
    engine = PromptEngine()
    assert 'main' in engine.templates
    assert 'infographic_1' in engine.templates
    assert 'infographic_2' in engine.templates
    assert 'lifestyle' in engine.templates
    assert 'comparison' in engine.templates

def test_main_image_prompt():
    """Test main image prompt generation"""
    engine = PromptEngine()
    context = ProductContext(
        title="Organic Sleep Gummies",
        features=[
            "All-natural melatonin formula",
            "Non-habit forming",
            "Delicious berry flavor"
        ],
        target_audience="Busy professionals aged 25-45",
        keywords=["sleep gummies", "natural sleep aid", "melatonin"],
        intents={
            "sleep gummies": ["problem_solution"],
            "natural sleep aid": ["durability", "problem_solution"],
            "melatonin": ["use_case"]
        }
    )

    prompt = engine.build_prompt('main', context)

    # Verify template populated
    assert "Organic Sleep Gummies" in prompt
    assert "All-natural melatonin formula" in prompt
    assert "Busy professionals aged 25-45" in prompt
    assert "white background" in prompt.lower()
    assert "2000x2000px" in prompt

def test_infographic_prompts():
    """Test infographic prompt generation"""
    engine = PromptEngine()
    context = ProductContext(
        title="Test Product",
        features=["Feature 1", "Feature 2", "Feature 3"],
        target_audience="Target audience",
        keywords=["test"],
        intents={}
    )

    prompt1 = engine.build_prompt('infographic_1', context)
    prompt2 = engine.build_prompt('infographic_2', context)

    assert "Feature 1" in prompt1
    assert "Feature 2" in prompt2
    assert "infographic" in prompt1.lower()
    assert "infographic" in prompt2.lower()

def test_intent_injection():
    """Test that intents are properly injected"""
    engine = PromptEngine()
    context = ProductContext(
        title="Test",
        features=["F1", "F2", "F3"],
        target_audience="Target",
        keywords=["test"],
        intents={"test": ["durability"]}
    )

    prompt = engine.build_prompt('main', context)
    assert "durability" in prompt.lower() or "durable" in prompt.lower()

def test_color_palette_inference():
    """Test category inference and color guidance"""
    from app.prompts.color_psychology import infer_category

    assert infer_category("Vitamin C Gummies", ["supplement"]) == "health_supplements"
    assert infer_category("Protein Powder", ["fitness", "workout"]) == "fitness"
    assert infer_category("Baby Monitor", ["baby"]) == "baby_kids"
    assert infer_category("Smart Watch", ["tech", "electronic"]) == "tech_electronics"

if __name__ == "__main__":
    pytest.main([__file__, "-v"])
```

### 2. Run Tests

```bash
pytest tests/test_prompt_templates.py -v
```

Expected output:
```
tests/test_prompt_templates.py::test_template_loading PASSED
tests/test_prompt_templates.py::test_main_image_prompt PASSED
tests/test_prompt_templates.py::test_infographic_prompts PASSED
tests/test_prompt_templates.py::test_intent_injection PASSED
tests/test_prompt_templates.py::test_color_palette_inference PASSED
```

---

## Reference Documentation

- **Creative Blueprint**: `docs/creative-blueprint.md` (complete reference)
- **Architecture**: `docs/architecture.md` Section 6 (Prompt Engineering Architecture)
- **PRD**: `docs/prd.md` Story 2.1b

---

## Dependencies

- **Upstream**: Story 2.1 (Gemini API Integration)
- **Downstream**: All image generation stories (2.3-2.6)

---

## Definition of Done

- [x] All 5 template files created with full Creative Blueprint compliance
- [x] PromptEngine class with variable injection
- [x] Intent modifier system implemented
- [x] Color psychology module complete
- [x] Templates tested and populate correctly
- [x] Code follows architecture patterns
- [x] Documentation complete

---

## Notes

- These templates are CORE IP - they determine image quality
- Templates should be iterable (stored as files, not hardcoded)
- Future: Add A/B testing capability for prompt variations
- Color psychology significantly impacts emotional resonance
- Intent alignment is the "closing the loop" strategy from Chris Rawlings
