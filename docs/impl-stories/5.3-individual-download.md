# Implementation Story 5.3: Individual Image Download

**Epic:** Output & Delivery (Phase 5)
**Story:** Download Single Images
**Priority:** Must Have
**Complexity:** Small
**Estimated Time:** 2-3 hours

---

## User Story

As a user, I want to download individual images so that I can choose which ones to use.

---

## Acceptance Criteria

- [ ] Download button visible for each image in gallery
- [ ] Download button visible in preview modal
- [ ] Images download as PNG format
- [ ] Filename includes image type (e.g., "listing_main_image.png")
- [ ] Download triggers browser's native download
- [ ] Download works on mobile devices
- [ ] Loading state shown during download

---

## Backend Implementation

### Download Endpoint

**File:** `app/api/endpoints/download.py`

```python
from fastapi import APIRouter, HTTPException, Depends
from fastapi.responses import FileResponse
from pathlib import Path
from sqlalchemy.orm import Session
from app.db.session import get_db
from app.models.database import GenerationSession, ImageRecord, ImageTypeEnum
from app.services.storage_service import StorageService
from app.config import settings

router = APIRouter()
storage = StorageService(settings.storage_path)

@router.get("/download/{session_id}/{image_type}")
async def download_image(
    session_id: str,
    image_type: ImageTypeEnum,
    db: Session = Depends(get_db)
):
    """
    Download a single generated image.

    Returns the image file as a PNG with proper filename.
    """
    # Find the image record
    image_record = db.query(ImageRecord).filter_by(
        session_id=session_id,
        image_type=image_type
    ).first()

    if not image_record:
        raise HTTPException(404, "Image not found")

    if image_record.status != "complete":
        raise HTTPException(400, "Image not ready for download")

    # Get file path from storage
    file_path = Path(image_record.storage_path)

    if not file_path.exists():
        raise HTTPException(404, "Image file not found")

    # Generate filename
    filename = f"listing_{image_type.value}.png"

    # Return file
    return FileResponse(
        path=str(file_path),
        filename=filename,
        media_type="image/png",
        headers={
            "Content-Disposition": f'attachment; filename="{filename}"'
        }
    )
```

### Register Router

**File:** `app/main.py`

```python
from fastapi import FastAPI
from app.api.endpoints import download

app = FastAPI()

# Include download router
app.include_router(
    download.router,
    prefix="/api",
    tags=["download"]
)
```

---

## Frontend Implementation

### API Client Method

**File:** `frontend/src/api/client.ts`

```typescript
class ApiClient {
  // ... existing code ...

  async downloadImage(sessionId: string, imageType: string): Promise<Blob> {
    const response = await this.client.get(
      `/download/${sessionId}/${imageType}`,
      {
        responseType: 'blob',
      }
    );
    return response.data;
  }
}

export const apiClient = new ApiClient();
```

### Download Function (Already in ImageCard.tsx from Story 5.1)

```tsx
const handleDownload = async (e: React.MouseEvent) => {
  e.stopPropagation();
  setIsDownloading(true);

  try {
    const sessionId = getSessionIdFromUrl(image.url);
    const blob = await apiClient.downloadImage(sessionId, image.type);

    // Create download link
    const url = window.URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = image.filename;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    window.URL.revokeObjectURL(url);
  } catch (error) {
    console.error('Download failed:', error);
    alert('Download failed. Please try again.');
  } finally {
    setIsDownloading(false);
  }
};
```

---

## Testing

### Backend Tests

**File:** `tests/test_api/test_download.py`

```python
def test_download_image_success(client, test_session):
    """Test successful image download"""
    response = client.get(f"/api/download/{test_session.id}/main")

    assert response.status_code == 200
    assert response.headers["content-type"] == "image/png"
    assert "attachment" in response.headers["content-disposition"]
    assert "listing_main.png" in response.headers["content-disposition"]

def test_download_image_not_found(client):
    """Test 404 for non-existent image"""
    response = client.get("/api/download/invalid-id/main")
    assert response.status_code == 404

def test_download_image_not_ready(client, test_session_pending):
    """Test 400 for image still generating"""
    response = client.get(f"/api/download/{test_session_pending.id}/main")
    assert response.status_code == 400
```

### Frontend Tests

```tsx
describe('Image Download', () => {
  it('should download image with correct filename', async () => {
    const mockBlob = new Blob(['test'], { type: 'image/png' });
    jest.spyOn(apiClient, 'downloadImage').mockResolvedValue(mockBlob);

    const { getByText } = render(<ImageCard image={mockImage} label="Main" onClick={() => {}} />);

    fireEvent.click(getByText('Download'));

    await waitFor(() => {
      expect(apiClient.downloadImage).toHaveBeenCalledWith('abc-123', 'main');
    });
  });

  it('should show error on download failure', async () => {
    jest.spyOn(apiClient, 'downloadImage').mockRejectedValue(new Error('Network error'));
    jest.spyOn(window, 'alert').mockImplementation(() => {});

    const { getByText } = render(<ImageCard image={mockImage} label="Main" onClick={() => {}} />);

    fireEvent.click(getByText('Download'));

    await waitFor(() => {
      expect(window.alert).toHaveBeenCalledWith('Download failed. Please try again.');
    });
  });
});
```

---

## API Specification

### Endpoint

```
GET /api/download/{session_id}/{image_type}
```

### Path Parameters

| Parameter | Type | Description |
|-----------|------|-------------|
| `session_id` | string (UUID) | The generation session ID |
| `image_type` | enum | One of: main, infographic_1, infographic_2, lifestyle, comparison |

### Response

**Success (200 OK):**
- Content-Type: `image/png`
- Content-Disposition: `attachment; filename="listing_{type}.png"`
- Body: Binary PNG data

**Errors:**
- `404 Not Found`: Image or session not found
- `400 Bad Request`: Image not ready for download
- `500 Internal Server Error`: Server error

---

## Filename Convention

| Image Type | Filename |
|------------|----------|
| main | `listing_main.png` |
| infographic_1 | `listing_infographic_1.png` |
| infographic_2 | `listing_infographic_2.png` |
| lifestyle | `listing_lifestyle.png` |
| comparison | `listing_comparison.png` |

---

## Definition of Done

- [ ] Backend endpoint implemented
- [ ] Frontend download function working
- [ ] Correct filenames applied
- [ ] Works on desktop and mobile
- [ ] Loading states implemented
- [ ] Error handling implemented
- [ ] Backend tests passing
- [ ] Frontend tests passing
- [ ] Downloads work in all browsers (Chrome, Firefox, Safari, Edge)
- [ ] No memory leaks (blob URLs properly revoked)
