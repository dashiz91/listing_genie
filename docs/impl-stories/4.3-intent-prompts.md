# Implementation Story 4.3: Intent-Aligned Image Generation

**Epic:** Epic 4 - Keyword Intent System
**Story ID:** 4.3
**Story Title:** Generate Images Matching Keyword Intent
**Priority:** Must Have
**Complexity:** Large

---

## Story Overview

**User Story:**
As a user, I want each image to visually prove the intent behind my keywords so that shoppers see exactly what they searched for.

**Business Value:**
This is the core of the "closing the loop" strategy - ensuring generated images visually prove the claims implied by search terms, dramatically increasing conversion rates by matching buyer expectations.

---

## Acceptance Criteria

- [ ] Prompts dynamically incorporate keyword intent
- [ ] Durability intent → show rugged textures, stress tests, comparison to competitors
- [ ] Use case intent → show product in that exact context (camping scene, office desk, etc.)
- [ ] Style intent → match visual aesthetic to style keywords
- [ ] Problem/solution intent → show before/after or relief/result
- [ ] Each image type prioritizes different intent groups:
  - Main Image: Quality/Premium intents
  - Lifestyle: Use Case intents
  - Infographics: Problem/Solution intents
  - Comparison: Comparison intents
- [ ] Keywords visible in generation metadata for reference

---

## Technical Context

### Intent-to-Image Type Mapping (from Creative Blueprint)

| Image Type | Primary Intent Focus | Secondary Intent |
|------------|---------------------|------------------|
| **Main Image** | Quality/Premium | Style/Aesthetic |
| **Infographic 1** | Problem/Solution | Durability |
| **Infographic 2** | Problem/Solution | Use Case |
| **Lifestyle** | Use Case | Style/Aesthetic |
| **Comparison** | Comparison | Durability/Quality |

### Visual Proof Requirements per Intent

| Intent Category | Visual Proof Required |
|-----------------|----------------------|
| **Durability/Quality** | Rugged textures, stress tests, premium materials, quality comparisons |
| **Use Case** | Product shown in that exact context/environment |
| **Style/Aesthetic** | Match visual aesthetic to style keywords |
| **Problem/Solution** | Before/after, relief expression, solved problem state |
| **Comparison** | Side-by-side superiority, check vs. X charts |

---

## Implementation Details

### Intent Modifiers System (Updated)

```python
# prompts/intent_modifiers.py

from typing import Dict, List
from app.services.keyword_service import IntentType

# Visual proof statements for each intent type
INTENT_VISUAL_PROOF = {
    IntentType.DURABILITY.value: [
        "Show rugged, premium materials and construction quality",
        "Emphasize durability through visual texture and build quality",
        "Include visual cues suggesting long-lasting performance",
        "Display professional-grade construction details"
    ],
    IntentType.USE_CASE.value: [
        "Show product in the exact context implied by search terms",
        "Visualize the specific use case scenario authentically",
        "Environment should match intended usage realistically",
        "Demonstrate product fitting naturally into this context"
    ],
    IntentType.STYLE.value: [
        "Match visual aesthetic to style-related keywords",
        "Color palette and composition should reflect style intent",
        "Design elements should resonate with aesthetic preferences",
        "Overall mood should align with style descriptors"
    ],
    IntentType.PROBLEM_SOLUTION.value: [
        "Visualize the solved state / positive outcome clearly",
        "Show relief, satisfaction, or resolution visually",
        "Before/after or transformation visual if appropriate",
        "Emphasize the benefit and solution, not the problem"
    ],
    IntentType.COMPARISON.value: [
        "Emphasize superiority and premium positioning",
        "Clear winner hierarchy in visual presentation",
        "Quality differentiation should be immediately obvious",
        "Use visual contrast to highlight advantages"
    ]
}

# Priority intents for each image type
IMAGE_TYPE_INTENT_PRIORITY = {
    'main': [IntentType.DURABILITY.value, IntentType.STYLE.value],
    'infographic_1': [IntentType.PROBLEM_SOLUTION.value, IntentType.DURABILITY.value],
    'infographic_2': [IntentType.PROBLEM_SOLUTION.value, IntentType.USE_CASE.value],
    'lifestyle': [IntentType.USE_CASE.value, IntentType.STYLE.value],
    'comparison': [IntentType.COMPARISON.value, IntentType.DURABILITY.value]
}

def get_intent_modifiers(
    image_type: str,
    keyword_intents: Dict[str, List[str]]
) -> str:
    """
    Generate intent-specific prompt modifiers for an image type.

    Args:
        image_type: The type of image being generated (main, infographic_1, etc.)
        keyword_intents: Mapping of keywords to their classified intents

    Returns:
        String of intent modifiers to inject into the prompt
    """
    # Collect all unique intents from keywords
    all_intents = set()
    for intents in keyword_intents.values():
        all_intents.update(intents)

    # Get priority intents for this image type
    priority_intents = IMAGE_TYPE_INTENT_PRIORITY.get(image_type, [])

    # Build modifier string
    modifiers = []
    for intent in priority_intents:
        if intent in all_intents:
            proof_statements = INTENT_VISUAL_PROOF.get(intent, [])
            if proof_statements:
                modifiers.append(f"\n[{intent.upper().replace('_', ' ')} INTENT]")
                modifiers.extend(f"- {stmt}" for stmt in proof_statements)

    if not modifiers:
        return "Focus on professional product presentation and visual appeal."

    return '\n'.join(modifiers)

def get_intent_specific_keywords(
    keyword_intents: Dict[str, List[str]],
    target_intent: str,
    limit: int = 3
) -> List[str]:
    """
    Extract keywords that match a specific intent.

    Args:
        keyword_intents: Mapping of keywords to intents
        target_intent: The intent type to filter for
        limit: Maximum number of keywords to return

    Returns:
        List of keywords matching the target intent
    """
    matching_keywords = []
    for keyword, intents in keyword_intents.items():
        if target_intent in intents:
            matching_keywords.append(keyword)

    return matching_keywords[:limit]

def build_intent_context(
    keyword_intents: Dict[str, List[str]],
    image_type: str
) -> str:
    """
    Build a context string explaining which keywords drove intent detection.

    Args:
        keyword_intents: Mapping of keywords to intents
        image_type: The image type being generated

    Returns:
        Context string for prompt
    """
    priority_intents = IMAGE_TYPE_INTENT_PRIORITY.get(image_type, [])

    context_parts = []
    for intent in priority_intents:
        matching_kw = get_intent_specific_keywords(keyword_intents, intent, limit=3)
        if matching_kw:
            intent_label = intent.replace('_', ' ').title()
            kw_list = ', '.join(f'"{kw}"' for kw in matching_kw)
            context_parts.append(
                f'{intent_label} keywords detected: {kw_list}'
            )

    if not context_parts:
        return ""

    return '\n'.join([
        "\n[KEYWORD INTENT ANALYSIS]",
        *context_parts
    ])
```

---

### Updated Prompt Templates

```python
# prompts/templates/main_image.py (Updated with Intent Injection)

TEMPLATE = """
Create a premium Amazon main product image.

[REFERENCE IMAGE]
Use the provided product photo as the base reference.
Maintain product accuracy while applying creative direction.

[PRODUCT CONTEXT]
Product: {product_title}
Key Benefit: {key_feature}
Target Audience: {target_audience}

[COMPOSITION REQUIREMENTS]
- Pure white background (#FFFFFF)
- Product fills 85% of frame
- Use dynamic "stacking" composition with depth
- If applicable, show ingredient elements (fruits, herbs, etc.) arranged aesthetically
- Professional studio lighting with subtle natural shadows
- Premium, tactile texture quality

[STYLE DIRECTION]
- High-end commercial product photography
- Visually "dense" and interesting
- Must stand out in Amazon search results grid
- No text, logos, or watermarks

[INTENT ALIGNMENT]
{intent_modifiers}

[KEYWORD CONTEXT]
{intent_context}
Top search terms: {top_keywords}
A shopper searching for "{primary_keyword}" should immediately see proof of that claim.

[TECHNICAL REQUIREMENTS]
- Resolution: 2000x2000px minimum
- Format: PNG with RGB color mode
- Amazon compliant: white background, product-focused

Enhance and stage the product, do not alter the product itself.
Generate an image that VISUALLY PROVES the intent behind these search terms.
"""
```

```python
# prompts/templates/lifestyle.py (Updated with Use Case Intent)

TEMPLATE = """
Create an Instagram-style lifestyle image for Amazon.

[REFERENCE IMAGE]
Use the provided product photo. Show it being used naturally in context.

[PRODUCT CONTEXT]
Product: {product_title}
Target Audience: {target_audience}
Key Features: {feature_1}, {feature_2}

[COMPOSITION REQUIREMENTS]
- Authentic, real-world setting
- Person using/enjoying product matches target demographic
- Warm, natural lighting (sunlit room, outdoor, etc.)
- Product clearly visible but naturally integrated
- Aspirational but relatable scene

[STYLE DIRECTION]
- High-end social media aesthetic
- Warm, inviting, authentic feel
- NOT clinical or stock-photo looking
- Model expression shows positive result of using product
- Emotional resonance with target audience

[INTENT ALIGNMENT]
{intent_modifiers}

[USE CASE VISUALIZATION]
{intent_context}
Based on keywords "{use_case_keywords}", show the product in a context
that matches these specific usage scenarios authentically.

Target audience: {target_audience}
The scene should reflect how THIS audience uses the product in THEIR environment.

[TECHNICAL REQUIREMENTS]
- Resolution: 2000x2000px
- Natural color grading
- Lifestyle context appropriate for product category

Generate an image that proves this product fits perfectly into the buyer's life.
"""
```

```python
# prompts/templates/infographic.py (Updated with Problem/Solution Intent)

TEMPLATE_1 = """
Create an Amazon infographic image highlighting a key benefit.

[REFERENCE IMAGE]
Use the provided product photo for accurate product representation.

[PRODUCT CONTEXT]
Product: {product_title}
Key Benefit: {feature_1}
Target Audience: {target_audience}

[COMPOSITION REQUIREMENTS]
- Product visible and prominent (center-left placement)
- Large, bold headline text highlighting the benefit
- Text is a DESIGN element, not just a caption
- High-contrast, legible at thumbnail size
- Text covers less than 20% of image area
- F-pattern reading flow consideration

[STYLE DIRECTION]
- Modern, clean infographic design
- Benefit-focused language (e.g., "Sleep Better" not "10mg Melatonin")
- Color palette matching product aesthetic
- Professional but approachable

[INTENT ALIGNMENT]
{intent_modifiers}

[PROBLEM/SOLUTION FOCUS]
{intent_context}
Keywords like "{problem_keywords}" indicate buyers are looking for a SOLUTION.
Show the SOLVED STATE or POSITIVE OUTCOME, not the problem.
Emphasize relief, satisfaction, improvement.

[KEYWORD ALIGNMENT]
Top keywords: {top_keywords}
Ensure visual elements prove the claims implied by these search terms.
The buyer searched for a solution - show them they found it.

[TECHNICAL REQUIREMENTS]
- Resolution: 2000x2000px
- Text readable at mobile thumbnail size
- Benefit headline must be immediately clear

Generate an infographic that instantly communicates problem solved.
"""
```

```python
# prompts/templates/comparison.py (Updated with Comparison Intent)

TEMPLATE = """
Create a comparison chart image for Amazon.

[REFERENCE IMAGE]
Use the provided product photo on the "our product" side.
Represent competitor as generic/unnamed alternative.

[PRODUCT CONTEXT]
Product: {product_title}
Our Advantages: {feature_2}, {feature_3}

[COMPOSITION REQUIREMENTS]
- "Us vs. Them" two-column layout
- Our product: vibrant colors, checkmarks (green ✓)
- Generic competitor: muted/greyscale, X-marks (red ✗)
- 3-4 comparison points based on features
- Clear visual hierarchy showing our product as winner

[STYLE DIRECTION]
- Professional infographic design
- Strong color contrast (green vs. red/grey)
- Text legible at thumbnail size
- Color psychology: warm/positive for us, cool/negative for them

[INTENT ALIGNMENT]
{intent_modifiers}

[COMPARISON FOCUS]
{intent_context}
Keywords like "{comparison_keywords}" show buyers are ACTIVELY COMPARING.
Make superiority IMMEDIATELY OBVIOUS through visual hierarchy.
Winner should be clear in under 2 seconds.

[COMPARISON POINTS]
1. {feature_2} (Us: Yes ✓, Them: No ✗)
2. {feature_3} (Us: Superior ✓, Them: Basic ✗)
3. Quality/Durability (Us: Premium ✓, Them: Standard ✗)
{comparison_keywords_visual}

[TECHNICAL REQUIREMENTS]
- Resolution: 2000x2000px
- Clear, scannable layout
- Winner should be immediately obvious

Generate a comparison that makes choosing us the obvious decision.
"""
```

---

### Updated Prompt Engine

```python
# prompts/engine.py (Updated)

from typing import Dict, List
from dataclasses import dataclass
from .templates import main_image, infographic, lifestyle, comparison
from .intent_modifiers import (
    get_intent_modifiers,
    build_intent_context,
    get_intent_specific_keywords
)

@dataclass
class ProductContext:
    title: str
    features: List[str]
    target_audience: str
    keywords: List[str]
    intents: Dict[str, List[str]]  # keyword -> list of intent types

class PromptEngine:
    """Constructs prompts for each image type with intent injection"""

    def __init__(self):
        self.templates = {
            'main': main_image.TEMPLATE,
            'infographic_1': infographic.TEMPLATE_1,
            'infographic_2': infographic.TEMPLATE_2,
            'lifestyle': lifestyle.TEMPLATE,
            'comparison': comparison.TEMPLATE,
        }

    def build_prompt(
        self,
        image_type: str,
        context: ProductContext
    ) -> str:
        """
        Build a complete prompt for the specified image type.

        Args:
            image_type: One of main, infographic_1, infographic_2, lifestyle, comparison
            context: Product information and keyword intents

        Returns:
            Complete prompt string ready for Gemini API
        """
        # Get base template
        template = self.templates[image_type]

        # Get intent modifiers for this image type
        intent_modifiers = get_intent_modifiers(image_type, context.intents)

        # Build intent context
        intent_context = build_intent_context(context.intents, image_type)

        # Extract intent-specific keywords
        use_case_kw = get_intent_specific_keywords(context.intents, 'use_case', 3)
        problem_kw = get_intent_specific_keywords(context.intents, 'problem_solution', 3)
        comparison_kw = get_intent_specific_keywords(context.intents, 'comparison', 3)

        # Select appropriate features for this image type
        feature_mapping = {
            'main': context.features[0],
            'infographic_1': context.features[0],
            'infographic_2': context.features[1],
            'lifestyle': context.target_audience,
            'comparison': f"{context.features[1]}, {context.features[2]}",
        }

        # Build variable dictionary
        variables = {
            'product_title': context.title,
            'key_feature': feature_mapping.get(image_type, context.features[0]),
            'feature_1': context.features[0],
            'feature_2': context.features[1],
            'feature_3': context.features[2],
            'target_audience': context.target_audience,
            'intent_modifiers': intent_modifiers,
            'intent_context': intent_context,
            'top_keywords': ', '.join(context.keywords[:5]),
            'primary_keyword': context.keywords[0] if context.keywords else '',
            'use_case_keywords': ', '.join(use_case_kw) if use_case_kw else 'general use',
            'problem_keywords': ', '.join(problem_kw) if problem_kw else 'benefits',
            'comparison_keywords': ', '.join(comparison_kw) if comparison_kw else 'quality',
            'comparison_keywords_visual': self._build_comparison_keywords_visual(comparison_kw)
        }

        # Render template
        prompt = template.format(**variables)

        return prompt

    def _build_comparison_keywords_visual(self, keywords: List[str]) -> str:
        """Build visual comparison points from keywords"""
        if not keywords:
            return ""

        points = []
        for i, kw in enumerate(keywords[:2], start=4):
            points.append(f"{i}. Based on '{kw}' (Us: Superior ✓, Them: Inferior ✗)")

        return '\n'.join(points)
```

---

## Testing Requirements

### Unit Tests

```python
# tests/unit/test_intent_prompts.py

import pytest
from app.prompts.engine import PromptEngine, ProductContext
from app.services.keyword_service import IntentType

@pytest.fixture
def sample_context():
    return ProductContext(
        title="Organic Sleep Gummies",
        features=[
            "All-natural melatonin",
            "Non-habit forming",
            "Delicious berry flavor"
        ],
        target_audience="Busy professionals seeking better sleep",
        keywords=[
            "premium sleep gummies",
            "for travel",
            "easy to use",
            "best melatonin",
            "modern packaging"
        ],
        intents={
            "premium sleep gummies": ["durability", "comparison"],
            "for travel": ["use_case"],
            "easy to use": ["problem_solution"],
            "best melatonin": ["comparison"],
            "modern packaging": ["style"]
        }
    )

def test_main_image_includes_durability_intent(sample_context):
    """Test that main image prompt includes durability intent modifiers"""
    engine = PromptEngine()
    prompt = engine.build_prompt('main', sample_context)

    assert "DURABILITY" in prompt or "durability" in prompt.lower()
    assert "premium materials" in prompt.lower() or "construction quality" in prompt.lower()

def test_lifestyle_includes_use_case_intent(sample_context):
    """Test that lifestyle prompt includes use case intent"""
    engine = PromptEngine()
    prompt = engine.build_prompt('lifestyle', sample_context)

    assert "USE CASE" in prompt or "use case" in prompt.lower()
    assert "for travel" in prompt.lower()
    assert "specific context" in prompt.lower() or "usage scenario" in prompt.lower()

def test_infographic_includes_problem_solution_intent(sample_context):
    """Test that infographic prompt includes problem/solution intent"""
    engine = PromptEngine()
    prompt = engine.build_prompt('infographic_1', sample_context)

    assert "PROBLEM" in prompt or "SOLUTION" in prompt
    assert "easy to use" in prompt.lower()
    assert "solved state" in prompt.lower() or "positive outcome" in prompt.lower()

def test_comparison_includes_comparison_intent(sample_context):
    """Test that comparison prompt includes comparison intent"""
    engine = PromptEngine()
    prompt = engine.build_prompt('comparison', sample_context)

    assert "COMPARISON" in prompt
    assert "best melatonin" in prompt.lower() or "premium" in prompt.lower()
    assert "superiority" in prompt.lower() or "winner" in prompt.lower()

def test_intent_specific_keywords_extracted(sample_context):
    """Test that intent-specific keywords are correctly extracted"""
    engine = PromptEngine()
    prompt = engine.build_prompt('lifestyle', sample_context)

    # Should include use_case keywords
    assert "for travel" in prompt.lower()

def test_primary_keyword_included(sample_context):
    """Test that primary keyword appears in prompt"""
    engine = PromptEngine()
    prompt = engine.build_prompt('main', sample_context)

    assert "premium sleep gummies" in prompt.lower()

def test_no_intent_keywords_fallback():
    """Test behavior when no intent keywords are detected"""
    context = ProductContext(
        title="Generic Product",
        features=["Feature 1", "Feature 2", "Feature 3"],
        target_audience="General audience",
        keywords=["product", "item", "thing", "stuff", "object"],
        intents={kw: [] for kw in ["product", "item", "thing", "stuff", "object"]}
    )

    engine = PromptEngine()
    prompt = engine.build_prompt('main', context)

    # Should have fallback language
    assert "professional product presentation" in prompt.lower()
```

### Integration Test

```python
# tests/integration/test_intent_generation_flow.py

import pytest
from fastapi.testclient import TestClient
from app.main import app
from sqlalchemy.orm import Session
from app.db.session import SessionLocal
from app.models.database import GenerationSession, SessionKeyword

client = TestClient(app)

def test_full_intent_generation_flow():
    """Test complete flow from keywords to intent-aligned generation"""

    # Step 1: Upload image
    with open("tests/fixtures/test-product.jpg", "rb") as f:
        upload_response = client.post(
            "/api/upload",
            files={"file": ("test-product.jpg", f, "image/jpeg")}
        )

    upload_id = upload_response.json()["upload_id"]

    # Step 2: Start generation with intent-rich keywords
    generate_response = client.post(
        "/api/generate",
        json={
            "upload_id": upload_id,
            "product_info": {
                "title": "Premium Camping Water Bottle",
                "features": [
                    "Keeps drinks cold 24 hours",
                    "BPA-free stainless steel",
                    "Leak-proof design"
                ],
                "target_audience": "Outdoor enthusiasts and campers"
            },
            "keywords": [
                "premium water bottle",
                "for camping",
                "keeps cold 24 hours",
                "easy to clean",
                "best insulated bottle"
            ]
        }
    )

    assert generate_response.status_code == 200
    session_id = generate_response.json()["session_id"]

    # Step 3: Verify keywords were classified and saved
    db = SessionLocal()
    session = db.query(GenerationSession).filter_by(id=session_id).first()

    assert session is not None
    assert len(session.keywords) == 5

    # Check that intents were classified
    durability_kw = [kw for kw in session.keywords if 'durability' in kw.intent_types]
    use_case_kw = [kw for kw in session.keywords if 'use_case' in kw.intent_types]
    problem_solution_kw = [kw for kw in session.keywords if 'problem_solution' in kw.intent_types]

    assert len(durability_kw) > 0  # "premium water bottle"
    assert len(use_case_kw) > 0    # "for camping"
    assert len(problem_solution_kw) > 0  # "easy to clean"

    db.close()
```

---

## Dependencies

- **Upstream:** Story 4.2 (Keyword Intent Classification)
- **Downstream:** Story 4.4 (Heatmap Optimization)
- **Related:** Story 2.1b (Prompt Engineering System)

---

## Definition of Done

- [ ] Intent modifiers inject visual proof requirements into prompts
- [ ] Each image type uses appropriate priority intents
- [ ] Prompts include intent-specific keywords
- [ ] Intent context explains which keywords drove detection
- [ ] All 5 image types updated with intent injection
- [ ] Unit tests cover all intent types and image types
- [ ] Integration test validates end-to-end flow
- [ ] Generated prompts include clear intent alignment language
- [ ] Documentation updated with intent injection examples
- [ ] QA verifies generated images reflect intent alignment

---

## Example Prompt Output

### Main Image with Durability Intent

```
Create a premium Amazon main product image.

[REFERENCE IMAGE]
Use the provided product photo as the base reference.
Maintain product accuracy while applying creative direction.

[PRODUCT CONTEXT]
Product: Premium Camping Water Bottle
Key Benefit: Keeps drinks cold 24 hours
Target Audience: Outdoor enthusiasts and campers

[COMPOSITION REQUIREMENTS]
- Pure white background (#FFFFFF)
- Product fills 85% of frame
- Use dynamic "stacking" composition with depth
- Professional studio lighting with subtle natural shadows
- Premium, tactile texture quality

[STYLE DIRECTION]
- High-end commercial product photography
- Visually "dense" and interesting
- Must stand out in Amazon search results grid
- No text, logos, or watermarks

[INTENT ALIGNMENT]

[DURABILITY INTENT]
- Show rugged, premium materials and construction quality
- Emphasize durability through visual texture and build quality
- Include visual cues suggesting long-lasting performance
- Display professional-grade construction details

[KEYWORD INTENT ANALYSIS]
Durability keywords detected: "premium water bottle", "best insulated bottle"

[KEYWORD CONTEXT]
Top search terms: premium water bottle, for camping, keeps cold 24 hours
A shopper searching for "premium water bottle" should immediately see proof of that claim.

[TECHNICAL REQUIREMENTS]
- Resolution: 2000x2000px minimum
- Format: PNG with RGB color mode
- Amazon compliant: white background, product-focused

Enhance and stage the product, do not alter the product itself.
Generate an image that VISUALLY PROVES the intent behind these search terms.
```

---

## Notes

- This story represents the core IP of the keyword intent system
- Quality of intent injection directly impacts conversion rates
- Each prompt should "close the loop" between search intent and visual proof
- Intent modifiers are additive - they enhance, not replace, base templates
- Testing should validate that intents are detectable in final prompts
- Consider A/B testing different intent modifier phrasing in future iterations
