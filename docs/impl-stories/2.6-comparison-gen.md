# Story 2.6: Comparison Chart Generation

**Epic:** Phase 2 - AI Core
**Priority:** Must Have
**Complexity:** Large
**Status:** Ready for Implementation

---

## User Story

As a user, I want a comparison chart showing my product's advantages so that customers can see why my product is better.

---

## Acceptance Criteria

- [ ] System generates comparison chart using specialized prompt
- [ ] Chart uses visual check vs X format
- [ ] Features from key features #2 and #3 are highlighted
- [ ] Strong color contrast for readability
- [ ] Professional, clean design
- [ ] Output resolution is 2000x2000px minimum
- [ ] Image saved to cloud storage with unique identifier
- [ ] Test: Generate comparison chart from test product

---

## Implementation Details

### Full Implementation

```python
# app/services/generation_service.py (continued)

async def generate_comparison_chart(
    session_id: str,
    db: Session,
    gemini: GeminiService,
    prompts: PromptEngine,
    storage: StorageService
) -> bool:
    """
    Generate comparison chart showing product superiority.

    Returns:
        True if successful, False otherwise
    """
    session = db.query(GenerationSession).filter_by(id=session_id).first()
    if not session:
        return False

    # Build product context
    keywords = {kw.keyword: kw.intent_types for kw in session.keywords}
    context = ProductContext(
        title=session.product_title,
        features=[session.feature_1, session.feature_2, session.feature_3],
        target_audience=session.target_audience,
        keywords=list(keywords.keys()),
        intents=keywords
    )

    # Find or create image record
    image_record = db.query(ImageRecord).filter_by(
        session_id=session_id,
        image_type=ImageTypeEnum.COMPARISON
    ).first()

    if not image_record:
        image_record = ImageRecord(
            session_id=session_id,
            image_type=ImageTypeEnum.COMPARISON
        )
        db.add(image_record)
        db.commit()

    try:
        # Update status to processing
        image_record.status = GenerationStatusEnum.PROCESSING
        db.commit()

        # Build prompt - comparison emphasizes COMPARISON and DURABILITY intents
        prompt = prompts.build_prompt('comparison', context)

        # Generate image
        generated_image = await gemini.generate_image(
            prompt=prompt,
            reference_image_path=session.upload_path,
            aspect_ratio="1:1"
        )

        if generated_image:
            # Save to storage
            path = storage.save_generated_image(
                session_id=session_id,
                image_type='comparison',
                image=generated_image
            )

            # Update record
            image_record.storage_path = path
            image_record.status = GenerationStatusEnum.COMPLETE
            image_record.completed_at = datetime.utcnow()
            db.commit()
            return True
        else:
            image_record.status = GenerationStatusEnum.FAILED
            image_record.error_message = "No image returned from API"
            db.commit()
            return False

    except Exception as e:
        image_record.status = GenerationStatusEnum.FAILED
        image_record.error_message = str(e)
        image_record.retry_count += 1
        db.commit()
        return False
```

---

## Creative Blueprint Requirements

From `docs/creative-blueprint.md` Section 2 - "The Comparison Visual":

### Visual Design Rules

| Your Product | Generic Competitor |
|--------------|-------------------|
| Vibrant colors | Muted, grey-scale tones |
| Checkmarks (âœ“) | X-marks (âœ—) |
| Highlighted, prominent | Faded, less prominent |
| Positive associations | Negative associations |

### Color Psychology

- **Green**: Positive, approval, winner
- **Red/Grey**: Negative, rejection, inferior
- **High Contrast**: Makes winner immediately obvious
- **Visual Weight**: Our product should dominate visually

### Comparison Point Examples

For "Organic Sleep Gummies":
1. âœ“ All-Natural Ingredients vs âœ— Synthetic Additives
2. âœ“ Non-Habit Forming vs âœ— Dependency Risk
3. âœ“ Delicious Berry Flavor vs âœ— Chalky Taste
4. âœ“ Third-Party Tested vs âœ— Unknown Quality

---

## Testing Instructions

### 1. Create Test

Create `tests/test_comparison_generation.py`:

```python
"""
Test Comparison Chart Generation
"""
import pytest
import asyncio
from pathlib import Path
from app.services.gemini_service import GeminiService
from app.prompts.engine import PromptEngine, ProductContext
from app.services.storage_service import StorageService

@pytest.mark.asyncio
async def test_generate_comparison_chart():
    """Test comparison chart generation with check vs X format"""
    gemini = GeminiService()
    prompts = PromptEngine()
    storage = StorageService(storage_path="./tests/output")

    context = ProductContext(
        title="Organic Sleep Gummies",
        features=[
            "All-natural melatonin formula",
            "Non-habit forming",
            "Delicious berry flavor"
        ],
        target_audience="Busy professionals",
        keywords=["best sleep gummies", "vs melatonin pills", "natural alternative"],
        intents={
            "best sleep gummies": ["comparison"],
            "vs melatonin pills": ["comparison"],
            "natural alternative": ["comparison", "durability"]
        }
    )

    test_image_path = Path(__file__).parent / "fixtures" / "test-product.jpg"
    if not test_image_path.exists():
        pytest.skip("Test product image not found")

    # Build prompt
    prompt = prompts.build_prompt('comparison', context)
    print(f"\nðŸ“Š Comparison Prompt:\n{prompt}\n")

    # Verify prompt contains comparison elements
    assert "comparison" in prompt.lower() or "vs" in prompt.lower()
    assert "checkmark" in prompt.lower() or "âœ“" in prompt or "check" in prompt.lower()
    assert "winner" in prompt.lower() or "superior" in prompt.lower()

    # Generate image
    generated_image = await gemini.generate_image(
        prompt=prompt,
        reference_image_path=str(test_image_path),
        aspect_ratio="1:1"
    )

    assert generated_image is not None, "Failed to generate comparison chart"

    # Verify dimensions
    width, height = generated_image.size
    assert width >= 2000 and height >= 2000

    # Save image
    output_path = storage.save_generated_image(
        session_id="test_session",
        image_type="comparison",
        image=generated_image
    )

    print(f"âœ… Comparison chart saved: {output_path}")


@pytest.mark.asyncio
async def test_comparison_uses_features_2_and_3():
    """Verify comparison chart emphasizes features 2 and 3"""
    prompts = PromptEngine()

    context = ProductContext(
        title="Test Product",
        features=["Feature 1", "Feature 2", "Feature 3"],
        target_audience="Target",
        keywords=["test"],
        intents={}
    )

    prompt = prompts.build_prompt('comparison', context)

    # Should reference features 2 and 3
    assert "Feature 2" in prompt
    assert "Feature 3" in prompt


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
```

### 2. Run Tests

```bash
pytest tests/test_comparison_generation.py -v -s
```

---

## Reference Documentation

- **Creative Blueprint**: Section 2 - "The Comparison Visual"
- **Architecture**: Section 5.5 - Comparison Prompt Template
- **PRD**: Story 2.5 - Comparison Chart Image

---

## Dependencies

- **Upstream**: Stories 2.1, 2.2
- **Downstream**: Story 2.7

---

## Definition of Done

- [x] Comparison generation function implemented
- [x] Prompt uses template from Story 2.2
- [x] Chart uses check vs X visual format
- [x] Strong color contrast (green vs red/grey)
- [x] Our product is visually dominant
- [x] Image meets resolution requirements
- [x] Image saved to storage
- [x] Test generates comparison chart
- [x] Error handling implemented

---

## Notes

- Comparison charts REMOVE DOUBT by proving superiority
- Winner should be IMMEDIATELY obvious visually
- Don't name competitor - use "generic" or "standard" alternatives
- Color psychology is critical: warm colors for us, cool/grey for them
- This is the final "convincer" image before purchase
