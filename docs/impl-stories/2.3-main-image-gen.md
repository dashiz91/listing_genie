# Story 2.3: Main Image Generation

**Epic:** Phase 2 - AI Core
**Priority:** Must Have
**Complexity:** Large
**Status:** Ready for Implementation

---

## User Story

As a user, I want a professional main image with dynamic composition so that my product stands out in Amazon search results.

---

## Acceptance Criteria

- [ ] System generates main image using specialized prompt
- [ ] Image has pure white background (#FFFFFF)
- [ ] Product fills 85%+ of frame
- [ ] Image includes dynamic composition elements (stacking, textures)
- [ ] No text or watermarks on main image
- [ ] Output resolution is 2000x2000px minimum
- [ ] Image is saved to cloud storage with unique identifier
- [ ] Test: Generate main image from test product

---

## Implementation Details

### Full Code Example

From `docs/architecture.md` Section 5.5 - this is the complete implementation:

```python
# app/services/generation_service.py

import asyncio
from typing import List, Dict
from datetime import datetime
from app.services.gemini_service import GeminiService
from app.prompts.engine import PromptEngine, ProductContext
from app.services.storage_service import StorageService
from app.models.database import GenerationSession, ImageRecord, GenerationStatusEnum, ImageTypeEnum
from sqlalchemy.orm import Session

async def generate_main_image(
    session_id: str,
    db: Session,
    gemini: GeminiService,
    prompts: PromptEngine,
    storage: StorageService
) -> bool:
    """
    Generate the main product image with dynamic composition.

    Returns:
        True if successful, False otherwise
    """
    # Load session
    session = db.query(GenerationSession).filter_by(id=session_id).first()
    if not session:
        return False

    # Build product context
    keywords = {kw.keyword: kw.intent_types for kw in session.keywords}
    context = ProductContext(
        title=session.product_title,
        features=[session.feature_1, session.feature_2, session.feature_3],
        target_audience=session.target_audience,
        keywords=list(keywords.keys()),
        intents=keywords
    )

    # Find or create image record
    image_record = db.query(ImageRecord).filter_by(
        session_id=session_id,
        image_type=ImageTypeEnum.MAIN
    ).first()

    if not image_record:
        image_record = ImageRecord(
            session_id=session_id,
            image_type=ImageTypeEnum.MAIN
        )
        db.add(image_record)
        db.commit()

    try:
        # Update status to processing
        image_record.status = GenerationStatusEnum.PROCESSING
        db.commit()

        # Build prompt using template
        prompt = prompts.build_prompt('main', context)

        # Generate image with reference
        generated_image = await gemini.generate_image(
            prompt=prompt,
            reference_image_path=session.upload_path,
            aspect_ratio="1:1"
        )

        if generated_image:
            # Save to storage
            path = storage.save_generated_image(
                session_id=session_id,
                image_type='main',
                image=generated_image
            )

            # Update record
            image_record.storage_path = path
            image_record.status = GenerationStatusEnum.COMPLETE
            image_record.completed_at = datetime.utcnow()
            db.commit()
            return True
        else:
            image_record.status = GenerationStatusEnum.FAILED
            image_record.error_message = "No image returned from API"
            db.commit()
            return False

    except Exception as e:
        image_record.status = GenerationStatusEnum.FAILED
        image_record.error_message = str(e)
        image_record.retry_count += 1
        db.commit()
        return False
```

---

## Testing Instructions

### 1. Create Test

Create `tests/test_main_image_generation.py`:

```python
"""
Test Main Image Generation
"""
import pytest
import asyncio
from pathlib import Path
from app.services.gemini_service import GeminiService
from app.prompts.engine import PromptEngine, ProductContext
from app.services.storage_service import StorageService

@pytest.mark.asyncio
async def test_generate_main_image():
    """Test full main image generation workflow"""
    # Initialize services
    gemini = GeminiService()
    prompts = PromptEngine()
    storage = StorageService(storage_path="./tests/output")

    # Test product context
    context = ProductContext(
        title="Organic Sleep Gummies - 60 Count",
        features=[
            "All-natural melatonin formula",
            "Non-habit forming",
            "Delicious berry flavor"
        ],
        target_audience="Busy professionals aged 25-45",
        keywords=["sleep gummies", "natural sleep aid", "melatonin gummies"],
        intents={
            "sleep gummies": ["problem_solution"],
            "natural sleep aid": ["durability", "problem_solution"],
            "melatonin gummies": ["use_case"]
        }
    )

    # Build prompt
    prompt = prompts.build_prompt('main', context)
    print(f"\nðŸ“ Generated Prompt:\n{prompt}\n")

    # Path to test product image
    test_image_path = Path(__file__).parent / "fixtures" / "test-product.jpg"
    if not test_image_path.exists():
        pytest.skip("Test product image not found")

    # Generate image
    generated_image = await gemini.generate_image(
        prompt=prompt,
        reference_image_path=str(test_image_path),
        aspect_ratio="1:1"
    )

    assert generated_image is not None, "Failed to generate main image"

    # Verify dimensions
    width, height = generated_image.size
    assert width >= 2000 and height >= 2000, f"Image too small: {width}x{height}"

    # Save image
    output_path = storage.save_generated_image(
        session_id="test_session",
        image_type="main",
        image=generated_image
    )

    print(f"âœ… Main image generated: {output_path}")
    assert Path(output_path).exists()


@pytest.mark.asyncio
async def test_main_image_has_white_background():
    """
    Verify main image has white background
    Note: This is a visual test - manual verification recommended
    """
    gemini = GeminiService()
    prompts = PromptEngine()

    context = ProductContext(
        title="Test Product",
        features=["Feature 1", "Feature 2", "Feature 3"],
        target_audience="Test audience",
        keywords=["test"],
        intents={}
    )

    prompt = prompts.build_prompt('main', context)

    # Verify prompt contains white background requirement
    assert "white background" in prompt.lower()
    assert "#FFFFFF" in prompt or "white" in prompt.lower()


if __name__ == "__main__":
    pytest.main([__file__, "-v"])
```

### 2. Run Test

```bash
pytest tests/test_main_image_generation.py -v -s
```

---

## Reference Documentation

- **Creative Blueprint**: Section 1 - "The Main Image: The Visual Hook"
- **Architecture**: Section 5.2 - Prompt Template System
- **PRD**: Story 2.2 - Main Image Generation

---

## Dependencies

- **Upstream**: Stories 2.1 (Gemini API), 2.2 (Prompt Templates)
- **Downstream**: Story 2.7 (Image Storage)

---

## Definition of Done

- [x] Main image generation function implemented
- [x] Prompt uses template from Story 2.2
- [x] Generated image meets Amazon requirements (white bg, 2000x2000px)
- [x] Image saved to storage
- [x] Test generates main image successfully
- [x] Error handling implemented
- [x] Database record updated correctly

---

## Notes

- Main image is the MOST IMPORTANT - it appears in search results
- Dynamic composition (stacking, depth) makes product stand out
- No text/watermarks on main image per Amazon requirements
- This image determines click-through rate from search
