# Implementation Story 5.1: Gallery Display

**Epic:** Output & Delivery (Phase 5)
**Story:** Display 5 Generated Images in Gallery Grid
**Priority:** Must Have
**Complexity:** Small
**Estimated Time:** 4-6 hours

---

## User Story

As a user, I want to see all 5 generated images in a gallery view so that I can review them before downloading.

---

## Acceptance Criteria

- [ ] Gallery displays all 5 generated images in responsive grid layout
- [ ] Each image labeled by type (Main, Infographic 1, Infographic 2, Lifestyle, Comparison)
- [ ] Images display with loading states (skeleton/placeholder)
- [ ] Grid is responsive: 1 column (mobile), 2 columns (tablet), 3 columns (desktop)
- [ ] Gallery loads automatically when all images are generated
- [ ] Success message displays above gallery
- [ ] Each image card has hover effects (desktop)

---

## Technical Requirements

### Frontend Component Structure

```
GalleryStep/
‚îú‚îÄ‚îÄ index.tsx                    # Main gallery container
‚îú‚îÄ‚îÄ GalleryGrid.tsx             # Grid layout component
‚îú‚îÄ‚îÄ ImageCard.tsx               # Individual image card
‚îú‚îÄ‚îÄ ImageCardSkeleton.tsx       # Loading skeleton
‚îú‚îÄ‚îÄ SuccessMessage.tsx          # Celebration message
‚îî‚îÄ‚îÄ styles.module.css           # Component styles
```

### State Management

**Context State (AppContext):**
```typescript
generatedImages: {
  main: GeneratedImage | null;
  infographic_1: GeneratedImage | null;
  infographic_2: GeneratedImage | null;
  lifestyle: GeneratedImage | null;
  comparison: GeneratedImage | null;
}

interface GeneratedImage {
  url: string;
  filename: string;
  type: ImageType;
  status: 'complete' | 'loading' | 'error';
}
```

---

## Implementation Details

### 1. Gallery Container Component

**File:** `frontend/src/pages/GalleryStep/index.tsx`

```tsx
import React from 'react';
import { useAppContext } from '../../contexts/AppContext';
import GalleryGrid from './GalleryGrid';
import SuccessMessage from './SuccessMessage';
import DownloadAllButton from './DownloadAllButton';
import ImagePreviewModal from './ImagePreviewModal';

export default function GalleryStep() {
  const { generatedImages, currentStep } = useAppContext();
  const [previewImage, setPreviewImage] = React.useState<string | null>(null);

  // Only render if we're on step 5 (gallery)
  if (currentStep !== 5) return null;

  const allImagesComplete = Object.values(generatedImages).every(
    img => img?.status === 'complete'
  );

  return (
    <div className="gallery-step">
      {/* Progress Indicator */}
      <div className="progress-indicator">
        <span className="step-circle complete">‚óè</span>
        <span className="step-circle complete">‚óè</span>
        <span className="step-circle complete">‚óè</span>
        <span className="step-circle complete">‚óè</span>
        <span className="step-circle complete">‚óè</span>
      </div>

      {/* Success Message */}
      {allImagesComplete && <SuccessMessage />}

      {/* Download All Button */}
      <DownloadAllButton disabled={!allImagesComplete} />

      {/* Gallery Grid */}
      <GalleryGrid
        images={generatedImages}
        onImageClick={setPreviewImage}
      />

      {/* Image Preview Modal */}
      {previewImage && (
        <ImagePreviewModal
          imageUrl={previewImage}
          onClose={() => setPreviewImage(null)}
        />
      )}

      {/* Secondary Action */}
      <div className="secondary-actions">
        <button className="btn-secondary" onClick={() => window.location.reload()}>
          ‚Üê Generate Another Listing
        </button>
      </div>
    </div>
  );
}
```

### 2. Gallery Grid Component

**File:** `frontend/src/pages/GalleryStep/GalleryGrid.tsx`

```tsx
import React from 'react';
import ImageCard from './ImageCard';
import ImageCardSkeleton from './ImageCardSkeleton';
import { GeneratedImage, ImageType } from '../../types';

interface GalleryGridProps {
  images: Record<ImageType, GeneratedImage | null>;
  onImageClick: (url: string) => void;
}

const IMAGE_LABELS: Record<ImageType, string> = {
  main: 'Main Product Image',
  infographic_1: 'Infographic 1',
  infographic_2: 'Infographic 2',
  lifestyle: 'Lifestyle Image',
  comparison: 'Comparison Chart',
};

export default function GalleryGrid({ images, onImageClick }: GalleryGridProps) {
  const imageTypes: ImageType[] = ['main', 'infographic_1', 'infographic_2', 'lifestyle', 'comparison'];

  return (
    <div className="gallery-grid">
      {imageTypes.map((type) => {
        const image = images[type];

        if (!image || image.status === 'loading') {
          return <ImageCardSkeleton key={type} label={IMAGE_LABELS[type]} />;
        }

        if (image.status === 'error') {
          return (
            <div key={type} className="image-card error">
              <div className="error-content">
                <span className="error-icon">‚ö†Ô∏è</span>
                <p>{IMAGE_LABELS[type]}</p>
                <p className="error-message">Generation failed</p>
              </div>
            </div>
          );
        }

        return (
          <ImageCard
            key={type}
            image={image}
            label={IMAGE_LABELS[type]}
            onClick={() => onImageClick(image.url)}
          />
        );
      })}
    </div>
  );
}
```

### 3. Image Card Component

**File:** `frontend/src/pages/GalleryStep/ImageCard.tsx`

```tsx
import React from 'react';
import { Download } from 'lucide-react';
import { GeneratedImage } from '../../types';
import { apiClient } from '../../api/client';

interface ImageCardProps {
  image: GeneratedImage;
  label: string;
  onClick: () => void;
}

export default function ImageCard({ image, label, onClick }: ImageCardProps) {
  const [isDownloading, setIsDownloading] = React.useState(false);

  const handleDownload = async (e: React.MouseEvent) => {
    e.stopPropagation(); // Prevent modal from opening
    setIsDownloading(true);

    try {
      // Extract session ID from image URL or use stored session ID
      const sessionId = getSessionIdFromUrl(image.url);
      const blob = await apiClient.downloadImage(sessionId, image.type);

      // Create download link
      const url = window.URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = image.filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      window.URL.revokeObjectURL(url);
    } catch (error) {
      console.error('Download failed:', error);
      alert('Download failed. Please try again.');
    } finally {
      setIsDownloading(false);
    }
  };

  return (
    <div className="image-card" onClick={onClick}>
      {/* Image Thumbnail */}
      <div className="image-wrapper">
        <img
          src={image.url}
          alt={label}
          className="image-thumbnail"
          loading="lazy"
        />

        {/* Hover Overlay (Desktop) */}
        <div className="hover-overlay">
          <span className="preview-hint">Click to preview</span>
        </div>
      </div>

      {/* Image Info */}
      <div className="image-info">
        <p className="image-label">{label}</p>

        {/* Download Button */}
        <button
          className="btn-download"
          onClick={handleDownload}
          disabled={isDownloading}
        >
          {isDownloading ? (
            <>
              <span className="spinner" />
              Downloading...
            </>
          ) : (
            <>
              <Download size={16} />
              Download
            </>
          )}
        </button>
      </div>
    </div>
  );
}

function getSessionIdFromUrl(url: string): string {
  // Extract session ID from image URL
  // Example: /api/images/abc-123-def/main.png -> abc-123-def
  const match = url.match(/\/images\/([^/]+)\//);
  return match ? match[1] : '';
}
```

### 4. Image Card Skeleton (Loading State)

**File:** `frontend/src/pages/GalleryStep/ImageCardSkeleton.tsx`

```tsx
import React from 'react';

interface ImageCardSkeletonProps {
  label: string;
}

export default function ImageCardSkeleton({ label }: ImageCardSkeletonProps) {
  return (
    <div className="image-card skeleton">
      {/* Shimmer animation container */}
      <div className="skeleton-image shimmer" />

      <div className="image-info">
        <p className="image-label">{label}</p>
        <div className="skeleton-button shimmer" />
      </div>
    </div>
  );
}
```

### 5. Success Message Component

**File:** `frontend/src/pages/GalleryStep/SuccessMessage.tsx`

```tsx
import React from 'react';
import { CheckCircle } from 'lucide-react';

export default function SuccessMessage() {
  return (
    <div className="success-message">
      <CheckCircle size={48} className="success-icon" />
      <h2>Your Images Are Ready!</h2>
      <p>All 5 listing images have been generated successfully.</p>
      <p className="helper-text">
        üí° These images are optimized for Amazon. Upload directly to Seller Central.
      </p>
    </div>
  );
}
```

---

## Styling

**File:** `frontend/src/pages/GalleryStep/styles.module.css`

```css
/* Gallery Step Container */
.gallery-step {
  max-width: 1200px;
  margin: 0 auto;
  padding: 2rem 1rem;
}

/* Success Message */
.success-message {
  text-align: center;
  margin-bottom: 3rem;
  animation: fadeInUp 0.5s ease-out;
}

.success-icon {
  color: #10B981;
  margin-bottom: 1rem;
  animation: scaleIn 0.4s ease-out;
}

.success-message h2 {
  font-size: 2rem;
  font-weight: 700;
  color: #111827;
  margin-bottom: 0.5rem;
}

.success-message p {
  font-size: 1.125rem;
  color: #6B7280;
}

.helper-text {
  margin-top: 1rem;
  font-size: 0.875rem;
  color: #10B981;
  font-weight: 500;
}

/* Gallery Grid */
.gallery-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: 1.5rem;
  margin: 2rem 0;
}

/* Tablet: 2 columns */
@media (min-width: 768px) {
  .gallery-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

/* Desktop: 3 columns */
@media (min-width: 1024px) {
  .gallery-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

/* Image Card */
.image-card {
  background: white;
  border: 1px solid #E5E7EB;
  border-radius: 12px;
  padding: 12px;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  overflow: hidden;
}

.image-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
  border-color: #10B981;
}

.image-wrapper {
  position: relative;
  width: 100%;
  padding-bottom: 100%; /* 1:1 aspect ratio */
  background: #F3F4F6;
  border-radius: 8px;
  overflow: hidden;
}

.image-thumbnail {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Hover Overlay */
.hover-overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.image-card:hover .hover-overlay {
  opacity: 1;
}

.preview-hint {
  color: white;
  font-size: 0.875rem;
  font-weight: 600;
}

/* Image Info */
.image-info {
  margin-top: 0.75rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 0.5rem;
}

.image-label {
  font-size: 0.875rem;
  font-weight: 600;
  color: #374151;
}

/* Download Button */
.btn-download {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: #10B981;
  color: white;
  border: none;
  border-radius: 6px;
  font-size: 0.875rem;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s ease;
}

.btn-download:hover {
  background: #059669;
}

.btn-download:disabled {
  background: #D1D5DB;
  cursor: not-allowed;
}

/* Skeleton Loading State */
.skeleton .skeleton-image {
  width: 100%;
  padding-bottom: 100%;
  background: linear-gradient(90deg, #F3F4F6 25%, #E5E7EB 50%, #F3F4F6 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 8px;
}

.skeleton .skeleton-button {
  width: 100px;
  height: 36px;
  background: linear-gradient(90deg, #F3F4F6 25%, #E5E7EB 50%, #F3F4F6 75%);
  background-size: 200% 100%;
  animation: shimmer 1.5s infinite;
  border-radius: 6px;
}

/* Error State */
.image-card.error {
  background: #FEF2F2;
  border-color: #FCA5A5;
  cursor: default;
}

.error-content {
  padding: 2rem;
  text-align: center;
}

.error-icon {
  font-size: 2rem;
  margin-bottom: 0.5rem;
}

.error-message {
  color: #DC2626;
  font-size: 0.875rem;
  margin-top: 0.5rem;
}

/* Animations */
@keyframes shimmer {
  0% {
    background-position: -200% 0;
  }
  100% {
    background-position: 200% 0;
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes scaleIn {
  from {
    transform: scale(0);
  }
  to {
    transform: scale(1);
  }
}

/* Mobile Adjustments */
@media (max-width: 767px) {
  .image-info {
    flex-direction: column;
    align-items: flex-start;
  }

  .btn-download {
    width: 100%;
    justify-content: center;
  }

  .hover-overlay {
    display: none; /* No hover on mobile */
  }
}
```

---

## Testing Requirements

### Unit Tests

**File:** `frontend/src/pages/GalleryStep/__tests__/GalleryGrid.test.tsx`

```tsx
import { render, screen } from '@testing-library/react';
import GalleryGrid from '../GalleryGrid';
import { GeneratedImage } from '../../../types';

describe('GalleryGrid', () => {
  const mockImages: Record<string, GeneratedImage> = {
    main: {
      url: '/images/test/main.png',
      filename: 'main_image.png',
      type: 'main',
      status: 'complete',
    },
    infographic_1: {
      url: '/images/test/info1.png',
      filename: 'infographic_1.png',
      type: 'infographic_1',
      status: 'complete',
    },
    // ... other images
  };

  it('should render all 5 image cards', () => {
    render(<GalleryGrid images={mockImages} onImageClick={() => {}} />);

    expect(screen.getByText('Main Product Image')).toBeInTheDocument();
    expect(screen.getByText('Infographic 1')).toBeInTheDocument();
    expect(screen.getByText('Infographic 2')).toBeInTheDocument();
    expect(screen.getByText('Lifestyle Image')).toBeInTheDocument();
    expect(screen.getByText('Comparison Chart')).toBeInTheDocument();
  });

  it('should show skeleton for loading images', () => {
    const loadingImages = {
      ...mockImages,
      main: { ...mockImages.main, status: 'loading' },
    };

    render(<GalleryGrid images={loadingImages} onImageClick={() => {}} />);

    const skeletons = screen.getAllByRole('presentation');
    expect(skeletons.length).toBeGreaterThan(0);
  });

  it('should show error state for failed images', () => {
    const errorImages = {
      ...mockImages,
      main: { ...mockImages.main, status: 'error' },
    };

    render(<GalleryGrid images={errorImages} onImageClick={() => {}} />);

    expect(screen.getByText('Generation failed')).toBeInTheDocument();
  });
});
```

### Integration Tests

**Test Scenario 1:** Gallery loads with all images
```typescript
test('Gallery displays all images after generation complete', async () => {
  // Mock API response with 5 complete images
  // Navigate to gallery step
  // Assert all 5 images visible
  // Assert download buttons enabled
});
```

**Test Scenario 2:** Individual image download
```typescript
test('User can download individual image', async () => {
  // Render gallery
  // Click download button on first image
  // Assert download triggered with correct filename
});
```

---

## API Integration

**Endpoint:** `GET /api/images/{session_id}`

**Response:**
```json
{
  "images": [
    {
      "type": "main",
      "url": "/api/download/abc-123/main",
      "filename": "listing_main_image.png",
      "status": "complete"
    },
    {
      "type": "infographic_1",
      "url": "/api/download/abc-123/infographic_1",
      "filename": "listing_infographic_1.png",
      "status": "complete"
    },
    // ... 3 more images
  ]
}
```

---

## Acceptance Testing Checklist

- [ ] All 5 images display in grid layout
- [ ] Images labeled correctly (Main, Infographic 1, etc.)
- [ ] Grid is responsive on mobile, tablet, desktop
- [ ] Skeleton loaders display during image loading
- [ ] Success message displays when all images ready
- [ ] Click image opens preview modal (Story 5.2)
- [ ] Download button per image works correctly (Story 5.3)
- [ ] Error states display for failed generations
- [ ] Hover effects work on desktop
- [ ] Gallery scrollable on mobile devices

---

## Definition of Done

- [ ] Gallery component implemented and rendering
- [ ] All 5 image types display correctly
- [ ] Responsive grid layout works on all breakpoints
- [ ] Loading states and error states implemented
- [ ] Individual download buttons functional
- [ ] Unit tests written and passing
- [ ] Integration tests written and passing
- [ ] Code reviewed and merged
- [ ] No console errors or warnings
- [ ] Accessibility tested (keyboard navigation, screen readers)
